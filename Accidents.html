<!DOCTYPE html>
<html>
<head>
	
	<title>CAIC Accident Explorer</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="shortcut icon" type="image/x-icon" href="images/blue_snow_icon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
	
		<!-- Loading Leaflet Omnivore to read CSV file -->
	<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>
  <!-- Loading Leaflet heatmap plugin -->
	<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-heat/v0.1.3/leaflet-heat.js'></script>
	
		<!-- Loading fontawesome -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"/>
	
	<!-- Loading Leaflet EasyButton -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
	<script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
	
	<!-- Loading Leaflet Lasso Button -->
	<script src="https://unpkg.com/leaflet-lasso@2.2.12/dist/leaflet-lasso.umd.min.js"></script>
	
	<!-- Loading jquery, moment.js, and daterangepicker -->
	<script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
	<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
	<link rel="stylesheet" type="text/css" href="Accidents.css">
	<!-- Loading chart.js -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	
	<!-- Loading jquery csv - can remove when lat/long included in api -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/1.0.21/jquery.csv.min.js"></script>
	
	<!-- Loading d3 -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>

	<!-- Loading dc -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/dc/4.2.7/dc.min.js"></script>
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/dc/4.2.7/style/dc.min.css" />

	<!-- Loading crossfilter -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.min.js"></script>
	
</head>
<body>	
	<div id='container'>
		<div id='map'>
			<div id="reportrange">
			    <i class="fa fa-calendar"></i>&nbsp;
			    <span></span> <i class="fa fa-caret-down"></i>
		    </div>
    	</div>
		<div id='side-panel'>
			<h2 id="CAIC">CAIC Accident Explorer</h2>
			<div id='chart-container'>
				<div id="chart-rose">
					<div id="pie-rose" class="row pie-row">
						<div class="col-xs-12 col-md-4">
							<div class="chart-wrapper">
								<div class="chart-title">
									Avalanche Rose 
									<span
										id="unknown-avy-rose-number-display" data-toggle="tooltip" data-placement="top"
										title="Incomplete elevation or aspect information has prevented some avalanches from being plotted on the rose.">
									</span>
								</div>
								<div class="chart-stage text-center">
									<a class="reset hidden within-chart" href="javascript:void(0)">
										<!-- <span class="icon">â†»</span> -->
									</a>
									<div id="rose-pie-chart" class='hidden'></div>
									<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 440 440" width="180">
										<g transform="matrix(1, 0, 0, 1, 28.720007, 28.720008)">
											<g class="avy-rose-part" filter="E <TL">
												<path d="M 376.21 127 L 376.21 273 L 329.82 253.78 L 329.82 146.26 L 376.21 127 Z" transform="translate(-8.72 -8.72)">
													<title>E &lt;TL</title>
												</path>
												<text transform="translate(345 193)" dominant-baseline="middle" text-anchor="middle">0</text>
											</g>
											<g class="avy-rose-part" filter="E TL">
												<path d="M 329.83 146.22 L 329.83 253.74 L 282.95 234.33 L 282.95 165.62 L 329.83 146.22 Z" transform="translate(-8.72 -8.72)">
													<title>E TL</title>
												</path>
												<text transform="translate(298 193)" dominant-baseline="middle" text-anchor="middle">0</text>
											</g>
											<g class="avy-rose-part" filter="E >TL">
												<path d="M 282.93 165.65 L 282.93 234.36 L 200 200 L 282.93 165.65 Z" transform="translate(-8.72 -8.72)">
													<title>E &gt;TL</title>
												</path>
												<text transform="translate(250 193)" dominant-baseline="middle" text-anchor="middle">0</text>
											</g>
											<g class="avy-rose-part" filter="SE >TL">
												<path d="M 200 200 L 282.94 234.36 L 234.36 283 L 200 200 Z" transform="translate(-8.72 -8.72)">
													<title>SE &gt;TL</title>
												</path>
												<text transform="translate(236 236)" dominant-baseline="middle" text-anchor="middle">0</text>
											</g>
											<g class="avy-rose-part" filter="SE TL">
												<path d="M 282.94 234.36 L 329.82 253.77 L 253.76 329.77 L 234.36 283 L 282.94 234.36 Z" transform="translate(-8.72 -8.72)">
													<title>SE TL</title>
												</path>
												<text transform="translate(267 267)" dominant-baseline="middle" text-anchor="middle">0</text>
											</g>
											<g class="avy-rose-part" filter="SE <TL">
												<path d="M 329.82 253.77 L 376.21 273 L 273 376.21 L 253.77 329.79 L 329.82 253.77 Z" transform="translate(-8.72 -8.72)">
													<title>SE &lt;TL</title>
												</path>
												<text transform="translate(300 300)" dominant-baseline="middle" text-anchor="middle">0</text>
											</g>
											<g class="avy-rose-part" filter="S <TL">
												<path d="M 253.76 329.79 L 273 376.21 L 127 376.21 L 146.22 329.81 L 253.76 329.79 Z" transform="translate(-8.72 -8.72)">
													<title>S &lt;TL</title>
												</path>
												<text transform="translate(191 348)" dominant-baseline="middle" text-anchor="middle">0</text>
											</g>
											<g class="avy-rose-part" filter="S TL">
												<path d="M 234.36 283 L 253.76 329.84 L 146.23 329.84 L 165.64 283 L 234.36 283 Z" transform="translate(-8.72 -8.72)">
													<title>S TL</title>
												</path>
												<text transform="translate(191 300)" dominant-baseline="middle" text-anchor="middle">0</text>
											</g>
											<g class="avy-rose-part" filter="S >TL">
												<path d="M 200 200 L 234.36 283 L 165.65 283 L 200 200 Z" transform="translate(-8.72 -8.72)">
													<title>S &gt;TL</title>
												</path>
												<text transform="translate(191 255)" dominant-baseline="middle" text-anchor="middle">0</text>
											</g>
											<g class="avy-rose-part" filter="SW >TL">
												<path d="M 200 200 L 165.64 283 L 117.07 234.4 L 200 200 Z" transform="translate(-8.72 -8.72)">
													<title>SW &gt;TL</title>
												</path>
												<text transform="translate(145 236)" dominant-baseline="middle" text-anchor="middle">0</text>
											</g>
											<g class="avy-rose-part" filter="SW TL">
												<path d="M 165.64 283 L 146.23 329.86 L 70.23 253.86 L 117.14 234.43 L 165.64 283 Z" transform="translate(-8.72 -8.72)">
													<title>SW TL</title>
												</path>
												<text transform="translate(115 267)" dominant-baseline="middle" text-anchor="middle">0</text>
											</g>
											<g class="avy-rose-part" filter="SW <TL">
												<path d="M 146.23 329.81 L 127 376.21 L 23.79 273 L 70.16 253.79 L 146.16 329.79 L 146.23 329.81 Z" transform="translate(-8.72 -8.72)">
													<title>SW &lt;TL</title>
												</path>
												<text transform="translate(83 300)" dominant-baseline="middle" text-anchor="middle">0</text>
											</g>
											<g class="avy-rose-part" filter="W <TL">
												<path d="M 70.16 253.78 L 23.79 273 L 23.79 127 L 70.12 146.2 L 70.16 253.78 Z" transform="translate(-8.72 -8.72)">
													<title>W &lt;TL</title>
												</path>
												<text transform="translate(38 193)" dominant-baseline="middle" text-anchor="middle">0</text>
											</g>
											<g class="avy-rose-part" filter="W TL">
												<path d="M 117.07 165.65 L 117.07 234.34 L 70.16 253.78 L 70.16 146.2 L 117.07 165.65 Z" transform="translate(-8.72 -8.72)">
													<title>W TL</title>
												</path>
												<text transform="translate(85 193)" dominant-baseline="middle" text-anchor="middle">0</text>
											</g>
											<g class="avy-rose-part" filter="W >TL">
												<path d="M 200 200 L 117.07 234.35 L 117.07 165.66 L 200 200 Z" transform="translate(-8.72 -8.72)">
													<title>W &gt;TL</title>
												</path>
												<text transform="translate(130 193)" dominant-baseline="middle" text-anchor="middle">0</text>
											</g>
											<g class="avy-rose-part" filter="NW >TL">
												<path d="M 165.65 117.08 L 200 200 L 117.07 165.65 L 165.65 117.08 Z" transform="translate(-8.72 -8.72)">
													<title>NW &gt;TL</title>
												</path>
												<text transform="translate(148 149)" dominant-baseline="middle" text-anchor="middle">0</text>
											</g>
											<g class="avy-rose-part" filter="N >TL">
												<path d="M 234.35 117.08 L 200 200 L 165.65 117.08 L 234.35 117.08 Z" transform="translate(-8.72 -8.72)">
													<title>N &gt;TL</title>
												</path>
												<text transform="translate(191 136)" dominant-baseline="middle" text-anchor="middle">0</text>
											</g>
											<g class="avy-rose-part" filter="NE >TL">
												<path d="M 234.35 117.08 L 282.92 165.65 L 200 200 L 234.35 117.08 Z" transform="translate(-8.72 -8.72)">
													<title>NE &gt;TL</title>
												</path>
												<text transform="translate(235 149)" dominant-baseline="middle" text-anchor="middle">0</text>
											</g>
											<g class="avy-rose-part" filter="NE TL">
												<path d="M 329.83 146.22 L 282.93 165.65 L 234.36 117.08 L 253.8 70.13 L 329.83 146.22 Z" transform="translate(-8.72 -8.72)">
													<title>NE TL</title>
												</path>
												<text transform="translate(266 120)" dominant-baseline="middle" text-anchor="middle">0</text>
											</g>
											<g class="avy-rose-part" filter="NE <TL">
												<path d="M 376.21 127 L 329.83 146.21 L 253.83 70.12 L 273 23.79 L 376.21 127 Z" transform="translate(-8.72 -8.72)">
													<title>NE &lt;TL</title>
												</path>
												<text transform="translate(300 85)" dominant-baseline="middle" text-anchor="middle">0</text>
											</g>
											<g class="avy-rose-part" filter="N <TL">
												<path d="M 273 23.79 L 253.8 70.13 L 146.24 70.13 L 127 23.79 L 273 23.79 Z" transform="translate(-8.72 -8.72)">
													<title>N &lt;TL</title>
												</path>
												<text transform="translate(191 40)" dominant-baseline="middle" text-anchor="middle">0</text>
											</g>
											<g class="avy-rose-part" filter="N TL">
												<path d="M 253.76 70.11 L 234.31 117.11 L 165.61 117.11 L 146.16 70.11 L 253.76 70.11 Z" transform="translate(-8.72 -8.72)">
													<title>N TL</title>
												</path>
												<text transform="translate(191 88)" dominant-baseline="middle" text-anchor="middle">0</text>
											</g>
											<g class="avy-rose-part" filter="NW TL">
												<path d="M 146.2 70.11 L 165.65 117.11 L 117.07 165.68 L 70.12 146.2 L 146.2 70.11 Z" transform="translate(-8.72 -8.72)">
													<title>NW TL</title>
												</path>
												<text transform="translate(117 120)" dominant-baseline="middle" text-anchor="middle">0</text>
											</g>
											<g class="avy-rose-part" filter="NW <TL">
												<path d="M 127 23.79 L 146.2 70.11 L 70.13 146.17 L 23.79 127 L 127 23.79 Z" transform="translate(-8.72 -8.72)">
													<title>NW &lt;TL</title>
												</path>
												<text transform="translate(85 85)" dominant-baseline="middle" text-anchor="middle">0</text>
											</g>
											<text 
												class="cardinal-direction rose-multiselector" dominant-baseline="middle" text-anchor="middle" x="191" y="-5"
												filter='["N >TL", "N TL", "N <TL", "NE >TL", "NE TL", "NE <TL", "NW >TL", "NW TL", "NW <TL"]'>
												N
											</text>
											<text 
												class="cardinal-direction rose-multiselector"  dominant-baseline="middle" text-anchor="middle" y="195" x="-12"
												filter='["W >TL", "W TL", "W <TL", "SW >TL", "SW TL", "SW <TL", "NW >TL", "NW TL", "NW <TL"]'>
												W
											</text>
											<text
												class="cardinal-direction rose-multiselector" dominant-baseline="middle" text-anchor="middle" x="387" y="195"
												filter='["E >TL", "E TL", "E <TL", "SE >TL", "SE TL", "SE <TL", "NE >TL", "NE TL", "NE <TL"]'>
												E
											</text>
											<text
												class="cardinal-direction rose-multiselector" dominant-baseline="middle" text-anchor="middle"  x="191" y="395"
												filter='["S >TL", "S TL", "S <TL", "SE >TL", "SE TL", "SE <TL", "SW >TL", "SW TL", "SW <TL"]'>
												S
											</text>
										</g>
									</svg>
									<span>
										<a href="javascript:void(0)" class="rose-multiselector" filter='["N <TL", "NE <TL", "E <TL", "SE <TL", "S <TL", "SW <TL", "W <TL", "NW <TL"]'>Below</a>
										<a href="javascript:void(0)" class="rose-multiselector" filter='["N <TL", "NE <TL", "E <TL", "SE <TL", "S <TL", "SW <TL", "W <TL", "NW <TL", "N TL", "NE TL", "E TL", "SE TL", "S TL", "SW TL", "W TL", "NW TL"]'>|</a>
										<a href="javascript:void(0)" class="rose-multiselector" filter='["N TL", "NE TL", "E TL", "SE TL", "S TL", "SW TL", "W TL", "NW TL"]'>Near</a>
										<a href="javascript:void(0)" class="rose-multiselector" filter='["N TL", "NE TL", "E TL", "SE TL", "S TL", "SW TL", "W TL", "NW TL", "N >TL", "NE >TL", "E >TL", "SE >TL", "S >TL", "SW >TL", "W >TL", "NW >TL"]'>|</a>
										<a href="javascript:void(0)" class="rose-multiselector" filter='["N >TL", "NE >TL", "E >TL", "SE >TL", "S >TL", "SW >TL", "W >TL", "NW >TL"]'>Above</a>
									</span>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div id='chart-travel'><canvas id="barChartCanvas"></canvas></div>
				<div id="chart-area" ><canvas id="bar-chart" ></canvas></div>
				<div id="chart-mode"><canvas id="bar-chart-mode"></canvas></div>
			</div>
		</div>
	</div>
	
	<script type="text/javascript" src="AvalancheRose.js"></script>
	<script type="text/javascript" src="zones.js"></script>
	<script type="text/javascript">
	
	var map = L.map('map').setView([39.118413163683854, -106.44565988833477], 7.5);

	var Natural_Atlas = L.tileLayer(
		'https://a-naturalatlas-tiles.global.ssl.fastly.net/topo/{z}/{x}/{y}/t@2x.jpg', {
		attribution: 'Tiles &copy; <a href="https://naturalatlas.com/"> Natural Atlas </a>',
		maxZoom: 13
		}).addTo(map);

	var imagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
		attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
		maxZoom: 13
	});
	
	var Esri_WorldTerrain = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}', {
		attribution: 'Tiles &copy; Esri &mdash; Source: Esri',
		maxZoom: 13
	});

	
	//Zoom settings for home button
	var home = {
		lat: 39.118413163683854,
		lng: -106.44565988833477,
		zoom: 7.5
		};


	//legend for all layers on
	var legendAll = L.control({ position: "bottomleft", orientation: 'horizontal'});
	legendAll.onAdd = function(map) {
	var div = L.DomUtil.create("div", "info legend");
		div.innerHTML += "<b>D Scale, 1 to 5</b></br>";
		div.innerHTML += '<i style="background: rgba(255, 255, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 232, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 208, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 184, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 159, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 132, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 103, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 69, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 0, 0)"></i><span></span><br><br>';
 		div.innerHTML += "<b>R Scale Circle Size, 1 to 5</b></br>";
		div.innerHTML += '<i style="border-radius: 50%; border-width: 1px; border: solid grey; width: 10px; height: 10px; margin-right: 2px; margin-top: 8px"></i><span></span>';
		div.innerHTML += '<i style="border-radius: 50%; border-width: 1px; border: solid grey; width: 12px; height: 12px; margin-right: 2px; margin-top: 6px"></i><span></span>';
		div.innerHTML += '<i style="border-radius: 50%; border-width: 1px; border: solid grey; width: 14px; height: 14px; margin-right: 2px; margin-top: 4px"></i><span></span>';
		div.innerHTML += '<i style="border-radius: 50%; border-width: 1px; border: solid grey; width: 16px; height: 16px; margin-right: 2px; margin-top: 2px"></i><span></span>';
		div.innerHTML += '<i style="border-radius: 50%; border-width: 1px; border: solid grey; width: 18px; height: 18px"></i><span></span><br><br>';
		div.innerHTML += "<b>Travel Mode</b></br>";
		div.innerHTML += '<img src="images/ski_icon.svg" style="height: 22px; width: 22px"></img><span></span>' + "  Ski/Snowboard<br>";
		div.innerHTML += '<img src="images/snowmobile_icon.svg" style="height: 22px; width: 22px"></img><span></span>' + "  Snowmobile<br>";
		div.innerHTML += '<img src="images/foot_icon.svg" style="height: 22px; width: 22px"></img><span></span>' + "  Hiker<br>";
		div.innerHTML += '<img src="images/snowshoe_icon.svg" style="height: 22px; width: 22px"></img><span></span>' + "  Snowshoer<br>";
		div.innerHTML += '<img src="images/other_icon.svg" style="height: 22px; width: 22px"></img><span></span>' + "  Other<br><br>";
		div.innerHTML += "<b>Heatmap, Least to Most Dense</b></br>";
		div.innerHTML += '<i style="background: cyan"></i><span></span>';
		div.innerHTML += '<i style="background: blue"></i><span></span>';
		div.innerHTML += '<i style="background: purple" ></i><span></span>';

		return div;
	};

	//legend for just Accidents layer
	var legendAcc = L.control({ position: "bottomleft", orientation: 'horizontal'});
	legendAcc.onAdd = function(map) {
	var div = L.DomUtil.create("div", "info legend");
		div.innerHTML += "<b>D Scale, 1 to 5</b></br>";
		div.innerHTML += '<i style="background: rgba(255, 255, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 232, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 208, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 184, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 159, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 132, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 103, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 69, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 0, 0)"></i><span></span><br><br>';
 		div.innerHTML += "<b>R Scale Circle Size, 1 to 5</b></br>";
		div.innerHTML += '<i style="border-radius: 50%; border-width: 1px; border: solid grey; width: 10px; height: 10px; margin-right: 2px; margin-top: 8px"></i><span></span>';
		div.innerHTML += '<i style="border-radius: 50%; border-width: 1px; border: solid grey; width: 12px; height: 12px; margin-right: 2px; margin-top: 6px"></i><span></span>';
		div.innerHTML += '<i style="border-radius: 50%; border-width: 1px; border: solid grey; width: 14px; height: 14px; margin-right: 2px; margin-top: 4px"></i><span></span>';
		div.innerHTML += '<i style="border-radius: 50%; border-width: 1px; border: solid grey; width: 16px; height: 16px; margin-right: 2px; margin-top: 2px"></i><span></span>';
		div.innerHTML += '<i style="border-radius: 50%; border-width: 1px; border: solid grey; width: 18px; height: 18px"></i><span></span>';

		return div;
	};

	//legend for Accident by Travel Mode layer
	var legendAccByType = L.control({ position: "bottomleft", orientation: 'horizontal'});
	legendAccByType.onAdd = function(map) {
	var div = L.DomUtil.create("div", "info legend");
	div.innerHTML += "<b>Travel Mode</b></br>";
		div.innerHTML += '<img src="images/ski_icon.svg" style="height: 22px; width: 22px"></img><span></span>' + "  Ski/Snowboard<br>";
		div.innerHTML += '<img src="images/snowmobile_icon.svg" style="height: 22px; width: 22px"></img><span></span>' + "  Snowmobile<br>";
		div.innerHTML += '<img src="images/foot_icon.svg" style="height: 22px; width: 22px"></img><span></span>' + "  Hiker<br>";
		div.innerHTML += '<img src="images/snowshoe_icon.svg" style="height: 22px; width: 22px"></img><span></span>' + "  Snowshoer<br>";
		div.innerHTML += '<img src="images/other_icon.svg" style="height: 22px; width: 22px"></img><span></span>' + "  Other";

		return div;
	};

	//legend for heatmap layer
	var legendHeatmap = L.control({ position: "bottomleft", orientation: 'horizontal'});
	legendHeatmap.onAdd = function(map) {
	var div = L.DomUtil.create("div", "info legend");
		div.innerHTML += "<b>Heatmap, Least to Most Dense</b></br>";
		div.innerHTML += '<i style="background: cyan"></i><span></span>';
		div.innerHTML += '<i style="background: blue"></i><span></span>';
		div.innerHTML += '<i style="background: purple" ></i><span></span>';

		return div;
	};

	var legendAccAndAccByType = L.control({ position: "bottomleft", orientation: 'horizontal'});
	legendAccAndAccByType.onAdd = function(map) {
	var div = L.DomUtil.create("div", "info legend");
		div.innerHTML += "<b>D Scale, 1 to 5</b></br>";
		div.innerHTML += '<i style="background: rgba(255, 255, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 232, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 208, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 184, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 159, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 132, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 103, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 69, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 0, 0)"></i><span></span><br><br>';
 		div.innerHTML += "<b>R Scale Circle Size, 1 to 5</b></br>";
		div.innerHTML += '<i style="border-radius: 50%; border-width: 1px; border: solid grey; width: 10px; height: 10px; margin-right: 2px; margin-top: 8px"></i><span></span>';
		div.innerHTML += '<i style="border-radius: 50%; border-width: 1px; border: solid grey; width: 12px; height: 12px; margin-right: 2px; margin-top: 6px"></i><span></span>';
		div.innerHTML += '<i style="border-radius: 50%; border-width: 1px; border: solid grey; width: 14px; height: 14px; margin-right: 2px; margin-top: 4px"></i><span></span>';
		div.innerHTML += '<i style="border-radius: 50%; border-width: 1px; border: solid grey; width: 16px; height: 16px; margin-right: 2px; margin-top: 2px"></i><span></span>';
		div.innerHTML += '<i style="border-radius: 50%; border-width: 1px; border: solid grey; width: 18px; height: 18px"></i><span></span><br><br>';
		div.innerHTML += "<b>Travel Mode</b></br>";
		div.innerHTML += '<img src="images/ski_icon.svg" style="height: 22px; width: 22px"></img><span></span>' + "  Ski/Snowboard<br>";
		div.innerHTML += '<img src="images/snowmobile_icon.svg" style="height: 22px; width: 22px"></img><span></span>' + "  Snowmobile<br>";
		div.innerHTML += '<img src="images/foot_icon.svg" style="height: 22px; width: 22px"></img><span></span>' + "  Hiker<br>";
		div.innerHTML += '<img src="images/snowshoe_icon.svg" style="height: 22px; width: 22px"></img><span></span>' + "  Snowshoer<br>";
		div.innerHTML += '<img src="images/other_icon.svg" style="height: 22px; width: 22px"></img><span></span>' + "  Other";

		return div;
	};

	var legendAccAndHeatmap = L.control({ position: "bottomleft", orientation: 'horizontal'});
	legendAccAndHeatmap.onAdd = function(map) {
	var div = L.DomUtil.create("div", "info legend");
		div.innerHTML += "<b>D Scale, 1 to 5</b></br>";
		div.innerHTML += '<i style="background: rgba(255, 255, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 232, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 208, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 184, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 159, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 132, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 103, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 69, 0)"></i><span></span>';
		div.innerHTML += '<i style="background: rgba(255, 0, 0)"></i><span></span><br><br>';
 		div.innerHTML += "<b>R Scale Circle Size, 1 to 5</b></br>";
		div.innerHTML += '<i style="border-radius: 50%; border-width: 1px; border: solid grey; width: 10px; height: 10px; margin-right: 2px; margin-top: 8px"></i><span></span>';
		div.innerHTML += '<i style="border-radius: 50%; border-width: 1px; border: solid grey; width: 12px; height: 12px; margin-right: 2px; margin-top: 6px"></i><span></span>';
		div.innerHTML += '<i style="border-radius: 50%; border-width: 1px; border: solid grey; width: 14px; height: 14px; margin-right: 2px; margin-top: 4px"></i><span></span>';
		div.innerHTML += '<i style="border-radius: 50%; border-width: 1px; border: solid grey; width: 16px; height: 16px; margin-right: 2px; margin-top: 2px"></i><span></span>';
		div.innerHTML += '<i style="border-radius: 50%; border-width: 1px; border: solid grey; width: 18px; height: 18px"></i><span></span><br><br>';
		div.innerHTML += "<b>Heatmap, Least to Most Dense</b></br>";
		div.innerHTML += '<i style="background: cyan"></i><span></span>';
		div.innerHTML += '<i style="background: blue"></i><span></span>';
		div.innerHTML += '<i style="background: purple" ></i><span></span>';

		return div;
	};

	var legendAccByTypeAndHeatmap = L.control({ position: "bottomleft", orientation: 'horizontal'});
	legendAccByTypeAndHeatmap.onAdd = function(map) {
	var div = L.DomUtil.create("div", "info legend");
	div.innerHTML += "<b>Travel Mode</b></br>";
		div.innerHTML += '<img src="images/ski_icon.svg" style="height: 22px; width: 22px"></img><span></span>' + "  Ski/Snowboard<br>";
		div.innerHTML += '<img src="images/snowmobile_icon.svg" style="height: 22px; width: 22px"></img><span></span>' + "  Snowmobile<br>";
		div.innerHTML += '<img src="images/foot_icon.svg" style="height: 22px; width: 22px"></img><span></span>' + "  Hiker<br>";
		div.innerHTML += '<img src="images/snowshoe_icon.svg" style="height: 22px; width: 22px"></img><span></span>' + "  Snowshoer<br>";
		div.innerHTML += '<img src="images/other_icon.svg" style="height: 22px; width: 22px"></img><span></span>' + "  Other<br><br>";
		div.innerHTML += "<b>Heatmap, Least to Most Dense</b></br>";
		div.innerHTML += '<i style="background: cyan"></i><span></span>';
		div.innerHTML += '<i style="background: blue"></i><span></span>';
		div.innerHTML += '<i style="background: purple" ></i><span></span>';

		return div;
	};

	//update what legend is showing based on what layers are on
	function updateLegend() {
		var hasAcc = map.hasLayer(acc);
		var hasAccByType = map.hasLayer(accByType);
		var hasHeat = map.hasLayer(heat);
		legendAll.remove();
		legendAcc.remove();
		legendAccByType.remove();
		legendHeatmap.remove();
		legendAccAndAccByType.remove();
		legendAccAndHeatmap.remove();
		legendAccByTypeAndHeatmap.remove();

		if ((hasAcc == true) && (hasAccByType == true) && (hasHeat == true)){legendAll.addTo(map)}
		else if ((hasAcc == true) && (hasAccByType == true)){legendAccAndAccByType.addTo(map)}
		else if ((hasAcc == true) && (hasHeat == true)){legendAccAndHeatmap.addTo(map)}
		else if ((hasAccByType == true) && (hasHeat)){legendAccByTypeAndHeatmap.addTo(map)}
		else if (hasAcc == true){legendAcc.addTo(map)}
		else if (hasAccByType == true){legendAccByType.addTo(map)}
		else if (hasHeat == true){legendHeatmap.addTo(map)};
	}

	map.on('layeradd', function(evt) {
  		updateLegend();
	});
	map.on('layerremove', function(evt) {
  		updateLegend();
	});


	
	var startDate, endDate, month=0, activity=0, mode=0;
	var lassoIDs=[];
	var roseFilters = rosePieChart.filters();
	var roseFiltersFlat = roseFilters.flat();

	function layerFilter(feature) {
		var roseFiltersFlat = roseFilters.flat();

		//Rose filter
		if (activity == 0 && monthSelected == 0 && modeSelected == 0 && lassoIDs.length == 0 && roseFilters.length>0) {
			if (roseFiltersFlat.includes(feature.properties.roseField)&& moment(feature.properties.datetime) >= startDate && moment(feature.properties.datetime) < endDate) {
				return true
			}
			else {
				return false
			}
		}
		//Activity filter
		if (activity != 0 && monthSelected == 0 && modeSelected == 0 && lassoIDs.length == 0 && roseFilters.length==0) {
			if (feature.properties.acc_activity == activity && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate) {
				return true
			}
			else {
				return false
			}
		}
		//Activity & rose filter
				if (activity != 0 && monthSelected == 0 && modeSelected == 0 && lassoIDs.length == 0 && roseFilters.length>0) {
			if (feature.properties.acc_activity == activity && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate && roseFiltersFlat.includes(feature.properties.roseField)) {
				return true
			}
			else {
				return false
			}
		}
		//Activity & lasso filter
		else if (activity != 0 && monthSelected == 0 && modeSelected == 0 && lassoIDs.length > 0 && roseFilters.length==0) {
			if (feature.properties.acc_activity == activity && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate && lassoIDs.includes(feature.properties.acc_id)) {
				return true
			}
			else {
				return false
			}
		}
		//Activity & lasso & rose filter
		else if (activity != 0 && monthSelected == 0 && modeSelected == 0 && lassoIDs.length > 0 && roseFilters.length>0) {
			if (feature.properties.acc_activity == activity && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate && lassoIDs.includes(feature.properties.acc_id) && roseFiltersFlat.includes(feature.properties.roseField)) {
				return true
			}
			else {
				return false
			}
		}
		//Travel Mode filter
		else if (mode != 0 && monthSelected == 0 && actSelected == 0 && lassoIDs.length == 0 && roseFilters.length==0) {
			if (feature.properties.acc_travel_mode == mode && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate) {
				return true
			}
			else {
				return false
			}
		}
		//Travel Mode + rose filter
		else if (mode != 0 && monthSelected == 0 && actSelected == 0 && lassoIDs.length == 0 && roseFilters.length>0) {
			if (feature.properties.acc_travel_mode == mode && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate && roseFiltersFlat.includes(feature.properties.roseField)) {
				return true
			}
			else {
				return false
			}
		}
		//Travel Mode + lasso filter
		else if (mode != 0 && monthSelected == 0 && actSelected == 0 && lassoIDs.length > 0 && roseFilters.length==0) {
			if (feature.properties.acc_travel_mode == mode && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate && lassoIDs.includes(feature.properties.acc_id)) {
				return true
			}
			else {
				return false
			}
		}
		//Travel Mode + lasso + rose filter
		else if (mode != 0 && monthSelected == 0 && actSelected == 0 && lassoIDs.length > 0 && roseFilters.length>0) {
			if (feature.properties.acc_travel_mode == mode && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate && lassoIDs.includes(feature.properties.acc_id) && roseFiltersFlat.includes(feature.properties.roseField)) {
				return true
			}
			else {
				return false
			}
		}
		//Activity + Month filter
		else if (activity != 0 && monthSelected == 1 && modeSelected == 0 && lassoIDs.length == 0 && roseFilters.length==0) {
			if (feature.properties.acc_activity == activity && moment(feature.properties.datetime).format("MMM") == month && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate) {
				return true
			}
			else {
				return false
			}
		}
		//Activity + Month + rose filter
		else if (activity != 0 && monthSelected == 1 && modeSelected == 0 && lassoIDs.length == 0 && roseFilters.length>0) {
			if (feature.properties.acc_activity == activity && moment(feature.properties.datetime).format("MMM") == month && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate && roseFiltersFlat.includes(feature.properties.roseField)) {
				return true
			}
			else {
				return false
			}
		}
		//Activity + Month + lasso filter
		else if (activity != 0 && monthSelected == 1 && modeSelected == 0 && lassoIDs.length > 0 && roseFilters.length==0) {
			if (feature.properties.acc_activity == activity && moment(feature.properties.datetime).format("MMM") == month && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate && lassoIDs.includes(feature.properties.acc_id)) {
				return true
			}
			else {
				return false
			}
		}
		//Activity + Month + lasso + rose filter
		else if (activity != 0 && monthSelected == 1 && modeSelected == 0 && lassoIDs.length > 0 && roseFilters.length>0) {
			if (feature.properties.acc_activity == activity && moment(feature.properties.datetime).format("MMM") == month && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate && lassoIDs.includes(feature.properties.acc_id) && roseFiltersFlat.includes(feature.properties.roseField)) {
				return true
			}
			else {
				return false
			}
		}
		//Activity + Travel Mode filter
		else if (activity != 0 && monthSelected == 0 && modeSelected == 1 && lassoIDs.length == 0 && roseFilters.length==0) {
			if (feature.properties.acc_activity == activity && feature.properties.acc_travel_mode == mode && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate) {
				return true
			}
			else {
				return false
			}
		}
		//Activity + Travel Mode + rose filter
		else if (activity != 0 && monthSelected == 0 && modeSelected == 1 && lassoIDs.length == 0 && roseFilters.length>0) {
			if (feature.properties.acc_activity == activity && feature.properties.acc_travel_mode == mode && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate && roseFiltersFlat.includes(feature.properties.roseField)) {
				return true
			}
			else {
				return false
			}
		}
		//Activity + Travel Mode + lasso filter
		else if (activity != 0 && monthSelected == 0 && modeSelected == 1 && lassoIDs.length > 0 && roseFilters.length==0) {
			if (feature.properties.acc_activity == activity && feature.properties.acc_travel_mode == mode && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate && lassoIDs.includes(feature.properties.acc_id)) {
				return true
			}
			else {
				return false
			}
		}
		//Activity + Travel Mode + lasso + rose filter
		else if (activity != 0 && monthSelected == 0 && modeSelected == 1 && lassoIDs.length > 0 && roseFilters.length>0) {
			if (feature.properties.acc_activity == activity && feature.properties.acc_travel_mode == mode && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate && lassoIDs.includes(feature.properties.acc_id) && roseFiltersFlat.includes(feature.properties.roseField)) {
				return true
			}
			else {
				return false
			}
		}
		//Travel Mode + Month filter
		else if (mode != 0 && monthSelected == 1 && actSelected == 0 && lassoIDs.length == 0 && roseFilters.length==0) {
			if (feature.properties.acc_travel_mode == mode && moment(feature.properties.datetime).format("MMM") == month && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate) {
				return true
			}
			else {
				return false
			}
		}
		//Travel Mode + Month + rose filter
		else if (mode != 0 && monthSelected == 1 && actSelected == 0 && lassoIDs.length == 0 && roseFilters.length>0) {
			if (feature.properties.acc_travel_mode == mode && moment(feature.properties.datetime).format("MMM") == month && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate && roseFiltersFlat.includes(feature.properties.roseField)) {
				return true
			}
			else {
				return false
			}
		}
		//Travel Mode + Month + lasso filter
		else if (mode != 0 && monthSelected == 1 && actSelected == 0 && lassoIDs.length > 0 && roseFilters.length==0) {
			if (feature.properties.acc_travel_mode == mode && moment(feature.properties.datetime).format("MMM") == month && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate && lassoIDs.includes(feature.properties.acc_id)) {
				return true
			}
			else {
				return false
			}
		}
		//Travel Mode + Month + lasso + rose filter
		else if (mode != 0 && monthSelected == 1 && actSelected == 0 && lassoIDs.length > 0 && roseFilters.length>0) {
			if (feature.properties.acc_travel_mode == mode && moment(feature.properties.datetime).format("MMM") == month && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate && lassoIDs.includes(feature.properties.acc_id) && roseFiltersFlat.includes(feature.properties.roseField)) {
				return true
			}
			else {
				return false
			}
		}
		//Travel Mode + Month + Activity filter
		else if (mode != 0 && monthSelected == 1 && actSelected == 1 && lassoIDs.length == 0 && roseFilters.length==0) {
			if (feature.properties.acc_travel_mode == mode && feature.properties.acc_activity == activity && moment(feature.properties.datetime).format("MMM") == month && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate) {
				return true
			}
			else {
				return false
			}
		}
		//Travel Mode + Month + Activity + rose filter
		else if (mode != 0 && monthSelected == 1 && actSelected == 1 && lassoIDs.length == 0 && roseFilters.length>0) {
			if (feature.properties.acc_travel_mode == mode && feature.properties.acc_activity == activity && moment(feature.properties.datetime).format("MMM") == month && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate && roseFiltersFlat.includes(feature.properties.roseField)) {
				return true
			}
			else {
				return false
			}
		}
		//Travel Mode + Month + Activity + lasso filter
		else if (mode != 0 && monthSelected == 1 && actSelected == 1 && lassoIDs.length > 0 && roseFilters.length==0) {
			if (feature.properties.acc_travel_mode == mode && feature.properties.acc_activity == activity && moment(feature.properties.datetime).format("MMM") == month && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate && lassoIDs.includes(feature.properties.acc_id)) {
				return true
			}
			else {
				return false
			}
		}
		//Travel Mode + Month + Activity + lasso + rose filter
		else if (mode != 0 && monthSelected == 1 && actSelected == 1 && lassoIDs.length > 0 && roseFilters.length>0) {
			if (feature.properties.acc_travel_mode == mode && feature.properties.acc_activity == activity && moment(feature.properties.datetime).format("MMM") == month && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate && lassoIDs.includes(feature.properties.acc_id) && roseFiltersFlat.includes(feature.properties.roseField)) {
				return true
			}
			else {
				return false
			}
		}
		//Month filter
		else if (month != 0 && actSelected == 0 && modeSelected == 0 && lassoIDs.length == 0 && roseFilters.length==0) {
			if (moment(feature.properties.datetime).format("MMM") == month && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate) {
				return true
			}
			else {
				return false
			}
		}
		//Month + rose filter
		else if (month != 0 && actSelected == 0 && modeSelected == 0 && lassoIDs.length == 0 && roseFilters.length>0) {
			if (moment(feature.properties.datetime).format("MMM") == month && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate && roseFiltersFlat.includes(feature.properties.roseField)) {
				return true
			}
			else {
				return false
			}
		}
		//Month + lasso filter
		else if (month != 0 && actSelected == 0 && modeSelected == 0 && lassoIDs.length > 0 && roseFilters.length==0) {
			if (moment(feature.properties.datetime).format("MMM") == month && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate && lassoIDs.includes(feature.properties.acc_id)) {
				return true
			}
			else {
				return false
			}
		}
		//Month + lasso + rose filter
		else if (month != 0 && actSelected == 0 && modeSelected == 0 && lassoIDs.length > 0 && roseFilters.length>0) {
			if (moment(feature.properties.datetime).format("MMM") == month && (moment(feature.properties.datetime)) >= startDate && (moment(feature.properties.datetime)) < endDate && lassoIDs.includes(feature.properties.acc_id) && roseFiltersFlat.includes(feature.properties.roseField)) {
				return true
			}
			else {
				return false
			}
		}
		//Date filter
		else {
			if ((moment(feature.properties.datetime)) >= startDate
				&& (moment(feature.properties.datetime)) < endDate) {
				return true
			}
			else {
				return false
			}
		}
	}

	function mapChange() {
		var hasAcc = map.hasLayer(acc);
		var hasAccByType = map.hasLayer(accByType);
		var hasZones = map.hasLayer(zones);
		var hasHeat = map.hasLayer(heat);
		map.removeLayer(acc);
		map.removeLayer(accByType);
		map.removeLayer(zones);
		map.removeLayer(heat);
		layerControl.removeLayer(acc);
		layerControl.removeLayer(accByType);
		layerControl.removeLayer(zones);
		layerControl.removeLayer(heat);
		startDate = moment(new Date($('#reportrange').data('daterangepicker').startDate));
		endDate = moment(new Date($('#reportrange').data('daterangepicker').endDate));
		acc = L.geoJson(apigeo, {
				pointToLayer: function(geoJsonPoint, latlng) {
				return L.circleMarker(latlng);},
				onEachFeature: onEachFeature,
				style:style,
				filter: layerFilter
		});
		accByType = L.geoJson(apigeo, {
				pointToLayer: function(geoJsonPoint, latlng) {
                return L.marker(latlng);},
				onEachFeature: onEachFeatureTravelMode,
				style: styleAccidentType,
				filter: layerFilter
		});
		heat = createHeatmap(map, accPoints, startDate, endDate, activity, month, mode, lassoIDs, roseFiltersFlat);
		if (hasAcc == true){acc.addTo(map)};
		if (hasAccByType == true){accByType.addTo(map)};
		if (hasZones == true){zones.addTo(map)};
		if (hasHeat == true){heat.addTo(map)};
		addOverlays();
	}
		
	//Adds home button to map
	L.easyButton('fa fa-home',function(btn,map){
		map.setView([home.lat, home.lng], home.zoom);
		},'Zoom To Home').addTo(map);

	//Add CAIC logo
	L.Control.Button = L.Control.extend({
		options: {
			position: 'bottomright',
			width:'120px'
		},
		onAdd: function (map) {
			var caicContainer = L.DomUtil.create('div', 'leaflet-control');
			$(caicContainer).html('<a href="https://avalanche.state.co.us/" target="_blank"><div id="caicLogo"></div></a>');
			return caicContainer;
		},
		onRemove: function(map) {},
	});
	var caicLogo = new L.Control.Button()
	caicLogo.addTo(map);
	
	//Add CMC GIS attribution
	L.Control.Button = L.Control.extend({
		options: {
			position: 'bottomright',
			width:'120px'
		},
		onAdd: function (map) {
			var cmcContainer = L.DomUtil.create('div', 'leaflet-control');
			$(cmcContainer).html('<div id="cmcLogo"> <p class="text">Joe Tayabji, Lucy Kepner, Dara Seidl | CMC GIS</p> </div>');
			return cmcContainer;
		},
		onRemove: function(map) {},
	});
	var cmcLogo = new L.Control.Button()
	cmcLogo.addTo(map);


	//Add lasso button	
	const lasso = L.lasso(map);
		
	L.easyButton('<img src="images/lasso.svg" style="width:19px; margin-top:6px">',function(btn,map){
		lasso.enable();
		},'Lasso').addTo(map);	
	map.on('lasso.finished', evt =>{
		lassoLayers(evt.layers);
	});

	function lassoLayers(layers) {
		var hasAcc = map.hasLayer(acc);
		var hasAccByType = map.hasLayer(accByType);
		var hasZones = map.hasLayer(zones);
		var hasHeat = map.hasLayer(heat);
		
		if (hasAcc == false && hasAccByType==false && hasHeat == true ){
		alert("Please turn on one of the accident point layers to filter by lasso.");
		}

		else if (layers.length==0){
			alert("No points in lasso area; please try again.");
		}
		else{
		
	 	actSelected = 0;
		monthSelected = 0;
		modeSelected = 0;
		roseSelected = 0;
		month=0;
		activity=0;
		mode = 0;
		firstSelect=0;
		secondSelect=0;
		thirdSelect=0;
		fourthSelect=0;

		map.removeLayer(acc);
		map.removeLayer(accByType);
		map.removeLayer(zones);
		map.removeLayer(heat);
		layerControl.removeLayer(acc);
		layerControl.removeLayer(accByType);
		layerControl.removeLayer(zones);
		layerControl.removeLayer(heat);
		lassoIDs.length = 0;
        layers.forEach(layer => {
				lassoIDs.push(layer.feature.properties.acc_id);
                });
		barLabels.length=0;
		barChartDates.length=0;
		barChartModeArr.length=0;
		roseData.length=0;
		rosePieChart.filterAll();
		roseFilters = rosePieChart.filters();
		function layerFilterL(feature) {
				if (lassoIDs.includes(feature.properties.acc_id) === true){
						return true
						
				}
				else {
						return false
					}
				}
		acc = L.geoJson(apigeo, {
				pointToLayer: function(geoJsonPoint, latlng) {
				return L.circleMarker(latlng);},
				onEachFeature: onEachFeature,
				style:style,
				filter: layerFilterL
		});
		accByType = L.geoJson(apigeo, {
				pointToLayer: function(geoJsonPoint, latlng) {
                return L.marker(latlng);},
				onEachFeature: onEachFeatureTravelMode,
				style: styleAccidentType,
				filter: layerFilterL
		});
		heat = createHeatmap(map, accPoints, startDate, endDate, activity, month, mode, lassoIDs, roseFiltersFlat);
		if (hasAcc == true){acc.addTo(map)};
		if (hasAccByType == true){accByType.addTo(map)};
		if (hasZones == true){zones.addTo(map)};
		if (hasHeat == true){heat.addTo(map)};
		addOverlays();
		updateActivityChart();
		processBarChartDates();
		processBarChartMode();
		processRose();
		}
		
        };

	
	//add Help button
	L.easyButton('fa-regular fa-circle-question', function(btn, map){
		onClick: window.open("Help.html", "_blank");
	},'Help with this map').addTo(map);

//Button to clear map filters
L.easyButton('fa fa-filter-circle-xmark',function(btn,map){
		actSelected = 0;
		monthSelected = 0;
		modeSelected = 0;
		roseSelected =0;
		month=0;
		activity=0;
		mode = 0;
		firstSelect=0;
		secondSelect=0;
		thirdSelect=0;
		fourthSelect=0;
		$('#reportrange').data('daterangepicker').startDate=moment('2018-10-01');
		$('#reportrange').data('daterangepicker').endDate=moment('2023-09-30');
		updateDisplayedDateRange(moment('2018-10-01'), moment('2023-09-30'));
		barLabels.length=0;
		barChartDates.length=0;
		barChartModeArr.length=0;
		roseData.length=0;
		lassoIDs.length=0;
		rosePieChart.filterAll();
		roseFilters = rosePieChart.filters();
		mapChange();
		updateActivityChart();
		processBarChartDates();
		processBarChartMode();
		processRose();
		},'Clear Filters').addTo(map);
		


	//Get style color by Dscale
	function getColor(d) {
		if (d !== null){
			d=d.substring(1);
			}
		return d < 1.5 ?  '#ffff00' :
				d < 2  ? '#ffe800' :
				d < 2.5  ? '#ffd000' :
				d < 3  ? '#ffb800':
				d < 3.5 ? '#ff9f00':
				d < 4 ? '#ff8400':
				d < 4.5 ? '#ff6700':
				d < 5 ? '#ff4500':
				d < 999 ? '#ff0000':
						 '#ffffff';
	};


	//Get radius by Rscale
	function getSize(d) {
		if (d !== null){
			d=d.substring(1);
			}
		return d < 1.5 ?  6 :
				d < 2  ? 6 :
				d < 2.5  ? 7 :
				d < 3  ? 7:
				d < 3.5 ? 8:
				d < 4 ? 8:
				d < 4.5 ? 9:
				d < 5 ? 9:
				d < 999 ? 10:
						 6;
	};

	//Set up icon variable to be used for accident travel modes
	var activityIcon = L.Icon.extend({
		options: {
			iconSize:     [27, 27],
			shadowSize:   [0, 0],
			iconAnchor:   [13.5, 13.5],
			shadowAnchor: [0, 0],
			popupAnchor:  [0, 0]
		}
	})

	//define each icon image for accident travel modes
	var skiIcon = new activityIcon({iconUrl: 'images/ski_icon.svg'}),
		footIcon = new activityIcon({iconUrl: 'images/foot_icon.svg'}),
		snowboardIcon = new activityIcon({iconUrl: 'images/ski_icon.svg'}),
		snowmobileIcon = new activityIcon({iconUrl: 'images/snowmobile_icon.svg'}),
		snowshoeIcon = new activityIcon({iconUrl: 'images/snowshoe_icon.svg'}),
		otherIcon = new activityIcon({iconUrl: 'images/other_icon.svg'});

	//Get style icon by accident activity (travel mode)
	function getIcon(feature) {
		var icon;
		var travelMode = feature.properties.acc_travel_mode;

		//get icon based on travel mode and trigger category
		if (travelMode == "Foot") icon = footIcon;
		else if (travelMode == "Ski") icon = skiIcon;
		else if (travelMode == "Snowboard") icon = snowboardIcon;
		else if (travelMode == "Snowmobile") icon = snowmobileIcon;
		else if (travelMode == "Snowshoe") icon = snowshoeIcon;
		else icon = otherIcon;

		return icon;
	}
	
	//Basic style for accident points
	function style(feature) {
		return {
			radius: getSize(feature.properties.Rscale),
			weight: 1.5,
			opacity: 1,
			color: 'white',
			dashArray: '',
			fillOpacity: 0.8,
			//Below is to set the color by a variable, in this case by Dscale)
			fillColor: getColor(feature.properties.Dscale)
		};
	}

	//Basic style for accident points BY TRAVEL MODE
	function styleAccidentType(feature) {
	}

	//Basic style for Avalanche Forecast Zones
	function styleForecastZones(feature) {
		return {
			weight: 1.5,
			opacity: 1,
			color: 'black',
			fillOpacity: 0.25,
			fillColor: 'grey',
		};
	}

	//Style of accident points upon cursor hover
	function highlightFeature(e) {
		var layer = e.target;

		layer.setStyle({
			weight: 3,
			color: '#666',
			dashArray: '',
			fillOpacity: 0.7
		});

		if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
			layer.bringToFront();
		}
	}

	//Style of forecast zones upon cursor hover
	function highlightZone(e) {
		var zone = e.target;

		zone.setStyle({
			weight: 2,
			color: '#FFFFFF',
			dashArray: '',
			fillOpacity: 0.7
		});
	}


	function resetHighlight(e) {
		acc.resetStyle(e.target);
	}

	function resetHighlightTravelMode(e) {
		accByType.resetStyle(e.target);
	}


	//Actions for mouseover, mouseout
	function resetZone(e) {
		zones.resetStyle(e.target);
	}

	//Actions for mouseover, mouseout for accident points
	function onEachFeature(feature, layer) {
		layer.on({
			mouseover: highlightFeature,
			mouseout: resetHighlight
		});

		//content of tool tip
		layer.bindTooltip(feature.properties.acc_location + "<br>" + (moment(feature.properties.datetime).format("MM/DD/YYYY")) +
			"<br>" + feature.properties.acc_activity + "<br>Caught: " + feature.properties.no_caught + 
			", Buried: " + feature.properties.no_buried + ", Killed: " + feature.properties.no_killed);

		//content of the popup
		layer.bindPopup("<strong>" + feature.properties.acc_location +"</strong><br>" + (moment(feature.properties.datetime).format("MM/DD/YYYY")) +
			"<br>" + feature.properties.acc_activity 
			+ "<br>" + feature.properties.Rscale + " " + feature.properties.Dscale +
			"<br>Caught: " + feature.properties.no_caught + 
			", Buried: " + feature.properties.no_buried + ", Killed: " + feature.properties.no_killed + 
			"<br><a href=" + feature.properties.report + " target=_blank>Link to Report</a>");
			
		//Pushing the acc_activity to the bar graph
		barLabels.push(feature.properties.acc_activity);
		/* use moment to get the month and push to bar chart for activity type */
		barChartDates.push(moment(feature.properties.datetime).format("MMM"));
		/* push to bar chart for travel mode graph*/
		barChartModeArr.push(feature.properties.acc_travel_mode);
		roseData.push({roseField:feature.properties.roseField});
	}

	//Actions for mouseover, mouseout for accident points BY TRAVEL MODE
	function onEachFeatureTravelMode(feature, layer) {
		layer.on({
			//mouseover: highlightFeature,
			//mouseout: resetHighlightTravelMode
		});

		//content of tool tip
		layer.bindTooltip(feature.properties.acc_location + "<br>" + (moment(feature.properties.datetime).format("MM/DD/YYYY")) +
			"<br>" + feature.properties.acc_activity + "<br>Caught: " + feature.properties.acc_no_caught + 
			", Buried: " + feature.properties.no_buried + ", Killed: " + feature.properties.acc_no_killed);

		//content of the popup
		layer.bindPopup("<strong>" + feature.properties.acc_location +"</strong><br>" + (moment(feature.properties.datetime).format("MM/DD/YYYY")) +
			"<br>" + feature.properties.acc_activity 
			+ "<br>" + feature.properties.Rscale + " " + feature.properties.Dscale +
			"<br>Caught: " + feature.properties.no_caught + 
			", Buried: " + feature.properties.no_buried + ", Killed: " + feature.properties.no_killed + 
			"<br><a href=" + feature.properties.report + " target=_blank>Link to Report</a>");
			
		//get icon for activity
		layer.setIcon(getIcon(feature));
	}


	//Actions for mouseover, mouseout for forecast zones
	function onEachZone(feature, layer) {
		layer.on({
			mouseover: highlightZone,
			mouseout: resetZone,
			'add': function(){
        			layer.bringToBack()
      			}
		});

		//content of the popup
		layer.bindPopup("<strong>" + feature.properties.name +"</strong><br>");
		
	}

		//Classify elevation into treeline
		function getTreeline(d) {
		return d < 11000 ?  '<TL' :
				d < 11700  ? 'TL' :
				d < 20000  ? '>TL' :
						 null;
	};

	var acc, accByType, zones, heat;
	//var heat;
	var heatPoints =[];
	var accPoints=[];
	const jsonURL = 'https://raw.githubusercontent.com/dseidlCoMtn/caic_accident/main/Accidents.json';
	const csvURL = 'https://raw.githubusercontent.com/dseidlCoMtn/caic_accident/main/CO_Accidents.csv';
	//const apiURL = 'https://lb-octonaut.avalanche.dev/api/v2/accident_reports?per=300&r[state_eq]=CO&r[is_public_eq]=true';
	//const apiURL = 'https://lb-octonaut.avalanche.dev/api/v2/avalanche_observations?per=300&r[is_incident_eq]=true';
	//const apiOptions = {method: 'GET', headers: {Accept: 'application/json', Authorization: ''}};
	const apigeo = {
        type: "FeatureCollection",
        features: [],
      };
	getData().catch(error => {
      console.error(error);
      });
	async function getData() {
	  //const response = await fetch(apiURL, apiOptions);
	  //const json = await response.json();
	  //console.log(json);
	  const response = await fetch(jsonURL);
	  const csvResponse = await fetch(csvURL);
	  const csvText = await csvResponse.text();
	  const json = await response.json();
	  const csvObj = $.csv.toObjects(csvText);

	  for (var i in json){
		var classicID = json[i].classic_accident_id;
		var latitude=0;
		var longitude=0;
		var travmode
		//switching travel modes with null to Unknown
		if (json[i].travel_mode === null){
				travmode="Unknown";
			}
		else{
			travmode = json[i].travel_mode;
			}
		let treeline = getTreeline(json[i].accident_locations[0].site_elevation);
		//Grabbing lat/longs from the CSV
		for (var j in csvObj){
			var classicID2 = parseInt(csvObj[j].acc_id);
			if (classicID2 === classicID){
				latitude=csvObj[j].acc_lat;
				longitude=csvObj[j].acc_lon;
				}
			}
		if (latitude != 0){
			apigeo.features.push({
				"type": "Feature",
				"geometry": {
				"type": "Point",
				"coordinates": [longitude, latitude]
				},
				"properties": {
					"id": json[i].id,
					"acc_id":json[i].classic_accident_id,
					"acc_type":json[i].classic_report_type,
					"report":json[i].classic_url,
					"url":json[i].url,
					"water_year":json[i].water_year,
					"datetime":json[i].observed_at,
					"acc_location":json[i].location,
					"acc_activity":json[i].activity,
					"acc_travel_mode":travmode,
					"acc_desc":json[i].description,
					"no_caught":json[i].summary_counts.caught,
					"no_buried":json[i].summary_counts.buried,
					"no_killed":json[i].summary_counts.killed,
					"atype":json[i].accident_avalanches[0].type_code,
					"trigger1":json[i].accident_avalanches[0].primary_trigger,
					"trigger2":json[i].accident_avalanches[0].secondary_trigger,
					"Rscale":json[i].accident_avalanches[0].relative_size,
					"Dscale":json[i].accident_avalanches[0].destructive_size,
					"surface":json[i].accident_avalanches[0].surface,
					"setting":json[i].accident_locations[0].setting,
					"elevation":json[i].accident_locations[0].site_elevation,
					"aspect":json[i].accident_locations[0].aspect,
					"slope":json[i].accident_locations[0].angle,
					"treeline":treeline,
					"roseField":json[i].accident_locations[0].aspect+" "+treeline
					//"slopeDesc":json[i].accident_locations[0].slope_characteristics,
					//"danger_rating":json[i].accident_avalanche_observations[0].danger_rating,
				}
				});
				const lat = parseFloat(latitude);
				const lon = parseFloat(longitude);
				const date = json[i].observed_at;
				const activ = json[i].activity;
				const travMode = travmode;
				const accID = json[i].classic_accident_id;
				const roseID = json[i].accident_locations[0].aspect+" "+treeline;
				heatPoints.push([lat, lon, date, activ, travMode, accID, roseID])
		}
		};
		startDate = moment(new Date($('#reportrange').data('daterangepicker').startDate));
		endDate = moment(new Date($('#reportrange').data('daterangepicker').endDate));
	  	acc = L.geoJson(apigeo, {
			pointToLayer: function(geoJsonPoint, latlng) {
                        return L.circleMarker(latlng);},
						onEachFeature: onEachFeature,
						style:style,
						filter:layerFilter
			}).addTo(map);

		accByType = L.geoJson(apigeo, {
			pointToLayer: function(geoJsonPoint, latlng) {
                        return L.marker(latlng);},
						onEachFeature: onEachFeatureTravelMode,
						style: styleAccidentType,
						filter:layerFilter
			});
			
		zones = L.geoJson(forecastZones, {
			style: styleForecastZones,
			onEachFeature: onEachZone
			});
		accPoints= await(heatPoints);
		heat = createHeatmap(map, accPoints, startDate, endDate);
		}

	var baseLayers = {
		"Natural Atlas": Natural_Atlas,
		"Imagery": imagery,
		"Esri Terrain": Esri_WorldTerrain,
	};
	var overlays = {};


	//Function to call L.heatLayer
	function createHeatmap(map, points, minDate, maxDate, activity, month, mode, lassoIDs, roseFiltersFlat) {
		const pointsArray = [];
		roseFiltersFlat = roseFilters.flat();
		//No graph selections + lasso
		if (activity == 0 && month == 0 && mode ==0 && lassoIDs != undefined && lassoIDs.length > 0 && roseFiltersFlat != undefined && roseFiltersFlat.length == 0){
			for (i in points) {
				const pointID = points[i][5];
				if (lassoIDs.includes(pointID) === true){
					pointsArray.push([points[i][0], points[i][1]]);
					}
				}
			}
		//Rose
		if (activity == 0 && month == 0 && mode ==0 && lassoIDs != undefined && lassoIDs.length == 0 && roseFiltersFlat != undefined && roseFiltersFlat.length > 0){
			for (i in points) {
				const pointRose = points[i][6];
				const pointDate = moment(points[i][2]);
				if (roseFiltersFlat.includes(pointRose) === true && (pointDate >= minDate) && (pointDate < maxDate)){
					pointsArray.push([points[i][0], points[i][1]]);
					}
				}
			}
		//Activity + month + mode
		else if (activity !=0 && month !=0 && mode!=0 && lassoIDs != undefined &&  lassoIDs.length == 0 && roseFiltersFlat != undefined && roseFiltersFlat.length == 0){
				for (i in points) {
					const pointActivity = points[i][3];
					const pointMonth = moment(points[i][2]).format("MMM");
					const pointMode = points[i][4];
					const pointDate = moment(points[i][2]);
					if ((pointActivity == activity) && (pointMonth == month) && (pointMode==mode) && (pointDate >= minDate) && (pointDate < maxDate))  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		//Activity + month + mode + rose
		else if (activity !=0 && month !=0 && mode!=0 && lassoIDs != undefined &&  lassoIDs.length == 0 && roseFiltersFlat != undefined && roseFiltersFlat.length > 0){
				for (i in points) {
					const pointActivity = points[i][3];
					const pointMonth = moment(points[i][2]).format("MMM");
					const pointMode = points[i][4];
					const pointDate = moment(points[i][2]);
					const pointRose = points[i][6];
					if ((pointActivity == activity) && (pointMonth == month) && (pointMode==mode) && (pointDate >= minDate) && (pointDate < maxDate) && roseFiltersFlat.includes(pointRose) === true)  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		//Activity + month + mode + lasso
		else if (activity !=0 && month !=0 && mode!=0 && lassoIDs != undefined && lassoIDs.length > 0 && roseFiltersFlat != undefined && roseFiltersFlat.length == 0){
				for (i in points) {
					const pointID = points[i][5];
					const pointActivity = points[i][3];
					const pointMonth = moment(points[i][2]).format("MMM");
					const pointMode = points[i][4];
					const pointDate = moment(points[i][2]);
					if ((pointActivity == activity) && (pointMonth == month) && (pointMode==mode) && (pointDate >= minDate) && (pointDate < maxDate) && lassoIDs.includes(pointID) == true)  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		//Activity + month + mode + lasso + rose
		else if (activity !=0 && month !=0 && mode!=0 && lassoIDs != undefined && lassoIDs.length > 0 && roseFiltersFlat != undefined && roseFiltersFlat.length > 0){
				for (i in points) {
					const pointID = points[i][5];
					const pointActivity = points[i][3];
					const pointMonth = moment(points[i][2]).format("MMM");
					const pointMode = points[i][4];
					const pointDate = moment(points[i][2]);
					const pointRose = points[i][6];
					if ((pointActivity == activity) && (pointMonth == month) && (pointMode==mode) && (pointDate >= minDate) && (pointDate < maxDate) && lassoIDs.includes(pointID) == true && roseFiltersFlat.includes(pointRose) === true)  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		//Activity + month
		else if (activity !=0 && month !=0 && mode ==0 && lassoIDs != undefined &&  lassoIDs.length == 0 && roseFiltersFlat != undefined && roseFiltersFlat.length == 0){
				for (i in points) {
					const pointActivity = points[i][3];
					const pointMonth = moment(points[i][2]).format("MMM");
					const pointDate = moment(points[i][2]);
					if ((pointActivity == activity) && (pointMonth == month) && (pointDate >= minDate) && (pointDate < maxDate))  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		//Activity + month + rose
		else if (activity !=0 && month !=0 && mode ==0 && lassoIDs != undefined &&  lassoIDs.length == 0 && roseFiltersFlat != undefined && roseFiltersFlat.length > 0){
				for (i in points) {
					const pointActivity = points[i][3];
					const pointMonth = moment(points[i][2]).format("MMM");
					const pointDate = moment(points[i][2]);
					const pointRose = points[i][6];
					if ((pointActivity == activity) && (pointMonth == month) && (pointDate >= minDate) && (pointDate < maxDate) && roseFiltersFlat.includes(pointRose) === true)  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		//Activity + month + lasso
		else if (activity !=0 && month !=0 && mode ==0 && lassoIDs != undefined &&  lassoIDs.length > 0 && roseFiltersFlat != undefined && roseFiltersFlat.length == 0){
				for (i in points) {
					const pointID = points[i][5];
					const pointActivity = points[i][3];
					const pointMonth = moment(points[i][2]).format("MMM");
					const pointDate = moment(points[i][2]);
					if ((pointActivity == activity) && (pointMonth == month) && (pointDate >= minDate) && (pointDate < maxDate)&& 	lassoIDs.includes(pointID) == true)  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		//Activity + month + lasso + rose
		else if (activity !=0 && month !=0 && mode ==0 && lassoIDs != undefined &&  lassoIDs.length > 0 && roseFiltersFlat != undefined && roseFiltersFlat.length > 0){
				for (i in points) {
					const pointID = points[i][5];
					const pointActivity = points[i][3];
					const pointMonth = moment(points[i][2]).format("MMM");
					const pointDate = moment(points[i][2]);
					const pointRose = points[i][6];
					if ((pointActivity == activity) && (pointMonth == month) && (pointDate >= minDate) && (pointDate < maxDate) && lassoIDs.includes(pointID) == true && roseFiltersFlat.includes(pointRose) === true)  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		//Activity + mode
		else if (activity !=0 && mode !=0 && month ==0 && lassoIDs != undefined &&  lassoIDs.length == 0 && roseFiltersFlat != undefined && roseFiltersFlat.length == 0){
				for (i in points) {
					const pointActivity = points[i][3];
					const pointDate = moment(points[i][2]);
					const pointMode = points[i][4];
					if ((pointActivity == activity) && (pointMode == mode) && (pointDate >= minDate) && (pointDate < maxDate))  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		//Activity + mode + rose
		else if (activity !=0 && mode !=0 && month ==0 && lassoIDs != undefined &&  lassoIDs.length == 0 && roseFiltersFlat != undefined && roseFiltersFlat.length > 0){
				for (i in points) {
					const pointActivity = points[i][3];
					const pointDate = moment(points[i][2]);
					const pointMode = points[i][4];
					const pointRose = points[i][6];
					if ((pointActivity == activity) && (pointMode == mode) && (pointDate >= minDate) && (pointDate < maxDate) && roseFiltersFlat.includes(pointRose) === true)  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		//Activity + mode + lasso
		else if (activity !=0 && mode !=0 && month ==0 && lassoIDs != undefined && lassoIDs.length > 0 && roseFiltersFlat != undefined && roseFiltersFlat.length == 0){
				for (i in points) {
					const pointID = points[i][5];
					const pointActivity = points[i][3];
					const pointDate = moment(points[i][2]);
					const pointMode = points[i][4];
					if ((pointActivity == activity) && (pointMode == mode) && (pointDate >= minDate) && (pointDate < maxDate) && lassoIDs.includes(pointID) == true)  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		//Activity + mode + lasso + rose
		else if (activity !=0 && mode !=0 && month ==0 && lassoIDs != undefined && lassoIDs.length > 0 && roseFiltersFlat != undefined && roseFiltersFlat.length > 0){
				for (i in points) {
					const pointID = points[i][5];
					const pointActivity = points[i][3];
					const pointDate = moment(points[i][2]);
					const pointMode = points[i][4];
					const pointRose = points[i][6];
					if ((pointActivity == activity) && (pointMode == mode) && (pointDate >= minDate) && (pointDate < maxDate) && lassoIDs.includes(pointID) == true && roseFiltersFlat.includes(pointRose) === true)  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		//Month + mode
		else if (month !=0 && mode !=0 && activity ==0 && lassoIDs != undefined && lassoIDs.length == 0 && roseFiltersFlat != undefined && roseFiltersFlat.length == 0){
				for (i in points) {
					const pointMonth = moment(points[i][2]).format("MMM");
					const pointDate = moment(points[i][2]);
					const pointMode = points[i][4];
					if ((pointMonth == month) && (pointMode == mode) && (pointDate >= minDate) && (pointDate < maxDate))  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		//Month + mode + rose
		else if (month !=0 && mode !=0 && activity ==0 && lassoIDs != undefined && lassoIDs.length == 0 && roseFiltersFlat != undefined && roseFiltersFlat.length > 0){
				for (i in points) {
					const pointMonth = moment(points[i][2]).format("MMM");
					const pointDate = moment(points[i][2]);
					const pointMode = points[i][4];
					const pointRose = points[i][6];
					if ((pointMonth == month) && (pointMode == mode) && (pointDate >= minDate) && (pointDate < maxDate) && roseFiltersFlat.includes(pointRose) === true)  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		//Month + mode + lasso
		else if (month !=0 && mode !=0 && activity ==0 && lassoIDs != undefined && lassoIDs.length > 0 && roseFiltersFlat != undefined && roseFiltersFlat.length == 0){
				for (i in points) {
					const pointID = points[i][5];
					const pointMonth = moment(points[i][2]).format("MMM");
					const pointDate = moment(points[i][2]);
					const pointMode = points[i][4];
					if ((pointMonth == month) && (pointMode == mode) && (pointDate >= minDate) && (pointDate < maxDate) && lassoIDs.includes(pointID) == true)  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		//Month + mode + lasso + rose
		else if (month !=0 && mode !=0 && activity ==0 && lassoIDs != undefined && lassoIDs.length > 0 && roseFiltersFlat != undefined && roseFiltersFlat.length > 0){
				for (i in points) {
					const pointID = points[i][5];
					const pointMonth = moment(points[i][2]).format("MMM");
					const pointDate = moment(points[i][2]);
					const pointMode = points[i][4];
					const pointRose = points[i][6];
					if ((pointMonth == month) && (pointMode == mode) && (pointDate >= minDate) && (pointDate < maxDate) && lassoIDs.includes(pointID) == true && roseFiltersFlat.includes(pointRose) === true)  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		//Activity only
		else if (activity !=0 && mode==0 && month==0 && lassoIDs != undefined && lassoIDs.length == 0 && roseFiltersFlat != undefined && roseFiltersFlat.length == 0){
				for (i in points) {
					const pointActivity = points[i][3];
					const pointDate = moment(points[i][2]);
					if ((pointActivity == activity) && (pointDate >= minDate) && (pointDate < maxDate))  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		//Activity + rose
		else if (activity !=0 && mode==0 && month==0 && lassoIDs != undefined && lassoIDs.length == 0 && roseFiltersFlat != undefined && roseFiltersFlat.length > 0){
				for (i in points) {
					const pointActivity = points[i][3];
					const pointDate = moment(points[i][2]);
					const pointRose = points[i][6];
					if ((pointActivity == activity) && (pointDate >= minDate) && (pointDate < maxDate) && roseFiltersFlat.includes(pointRose) === true)  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		//Activity + lasso
		else if (activity !=0 && mode==0 && month==0 && lassoIDs != undefined && lassoIDs.length > 0 && roseFiltersFlat != undefined && roseFiltersFlat.length == 0){
				for (i in points) {
					const pointID = points[i][5];
					const pointActivity = points[i][3];
					const pointDate = moment(points[i][2]);
					if ((pointActivity == activity) && (pointDate >= minDate) && (pointDate < maxDate)&& lassoIDs.includes(pointID) == true)  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		//Activity + lasso + rose
		else if (activity !=0 && mode==0 && month==0 && lassoIDs != undefined && lassoIDs.length > 0 && roseFiltersFlat != undefined && roseFiltersFlat.length > 0){
				for (i in points) {
					const pointID = points[i][5];
					const pointActivity = points[i][3];
					const pointDate = moment(points[i][2]);
					const pointRose = points[i][6];
					if ((pointActivity == activity) && (pointDate >= minDate) && (pointDate < maxDate)&& lassoIDs.includes(pointID) == true && roseFiltersFlat.includes(pointRose) === true)  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		//Month only
		else if (month !=0 && activity==0 && mode==0 && lassoIDs != undefined && lassoIDs.length == 0 && roseFiltersFlat != undefined && roseFiltersFlat.length == 0){
				for (i in points) {
					const pointMonth = moment(points[i][2]).format("MMM");
					const pointDate = moment(points[i][2]);
					if ((pointMonth == month) && (pointDate >= minDate) && (pointDate < maxDate))  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		//Month + rose
		else if (month !=0 && activity==0 && mode==0 && lassoIDs != undefined && lassoIDs.length == 0 && roseFiltersFlat != undefined && roseFiltersFlat.length > 0){
				for (i in points) {
					const pointMonth = moment(points[i][2]).format("MMM");
					const pointDate = moment(points[i][2]);
					const pointRose = points[i][6];
					if ((pointMonth == month) && (pointDate >= minDate) && (pointDate < maxDate) && roseFiltersFlat.includes(pointRose) === true)  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		//Month + lasso
		else if (month !=0 && activity==0 && mode==0 && lassoIDs != undefined && lassoIDs.length > 0 && roseFiltersFlat != undefined && roseFiltersFlat.length == 0){
				for (i in points) {
					const pointID = points[i][5];
					const pointMonth = moment(points[i][2]).format("MMM");
					const pointDate = moment(points[i][2]);
					if ((pointMonth == month) && (pointDate >= minDate) && (pointDate < maxDate)&& lassoIDs.includes(pointID) == true)  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		//Month + lasso + rose
		else if (month !=0 && activity==0 && mode==0 && lassoIDs != undefined && lassoIDs.length > 0 && roseFiltersFlat != undefined && roseFiltersFlat.length > 0){
				for (i in points) {
					const pointID = points[i][5];
					const pointMonth = moment(points[i][2]).format("MMM");
					const pointDate = moment(points[i][2]);
					const pointRose = points[i][6];
					if ((pointMonth == month) && (pointDate >= minDate) && (pointDate < maxDate)&& lassoIDs.includes(pointID) == true && roseFiltersFlat.includes(pointRose) === true)  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		//Mode only
		else if (mode !=0 && activity==0 && month==0 && lassoIDs != undefined && lassoIDs.length == 0 && roseFiltersFlat != undefined && roseFiltersFlat.length == 0){
				for (i in points) {
					const pointMode = points[i][4];
					const pointDate = moment(points[i][2]);
					if ((pointMode == mode) && (pointDate >= minDate) && (pointDate < maxDate))  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		//Mode + rose
		else if (mode !=0 && activity==0 && month==0 && lassoIDs != undefined && lassoIDs.length == 0 && roseFiltersFlat != undefined && roseFiltersFlat.length > 0){
				for (i in points) {
					const pointMode = points[i][4];
					const pointDate = moment(points[i][2]);
					const pointRose = points[i][6];
					if ((pointMode == mode) && (pointDate >= minDate) && (pointDate < maxDate) && roseFiltersFlat.includes(pointRose) === true)  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		//Mode + lasso
		else if (mode !=0 && activity==0 && month==0 && lassoIDs != undefined && lassoIDs.length > 0 && roseFiltersFlat != undefined && roseFiltersFlat.length == 0){
				for (i in points) {
					const pointID = points[i][5];
					const pointMode = points[i][4];
					const pointDate = moment(points[i][2]);
					if ((pointMode == mode) && (pointDate >= minDate) && (pointDate < maxDate)&& lassoIDs.includes(pointID) == true)  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		//Mode + lasso + rose
		else if (mode !=0 && activity==0 && month==0 && lassoIDs != undefined && lassoIDs.length > 0 && roseFiltersFlat != undefined && roseFiltersFlat.length > 0){
				for (i in points) {
					const pointID = points[i][5];
					const pointMode = points[i][4];
					const pointDate = moment(points[i][2]);
					const pointRose = points[i][6];
					if ((pointMode == mode) && (pointDate >= minDate) && (pointDate < maxDate)&& lassoIDs.includes(pointID) == true && roseFiltersFlat.includes(pointRose) === true)  {
						pointsArray.push([points[i][0], points[i][1]]);	
						}
					} 
			}
		else{
				//check if the date picker has been used
				if ((minDate != undefined) && (maxDate != undefined)) {
					for (i in points) {
						const pointDate = moment(points[i][2]);
						if ((pointDate >= minDate) && (pointDate < maxDate))  {
							pointsArray.push([points[i][0], points[i][1]]);
						}
					}
				} else {
					for (i in points) {
						pointsArray.push([points[i][0], points[i][1]]);
					}
				}

			}
		return L.heatLayer(pointsArray, {
			radius: 21,
			blur: 12,
			minOpacity: 0.4,
			gradient: {.3: 'cyan', 0.7: 'blue', .98: 'purple'},
			maxZoom: 25
			});
	};
		
	//needed to set the layerControl as a variable so we can call it in
	//later filter function for dates
	const layerControl = L.control.layers(baseLayers, overlays, {collapsed: false});
	
	//function to add control layers to map
	function addControlLayersToMap(baseLayers, overlays, map) {
		layerControl.addOverlay(acc, "Accidents");
		layerControl.addOverlay(accByType, "Accidents by Travel Mode");
		layerControl.addOverlay(zones, "CAIC Zones");
		layerControl.addOverlay(heat, "Heatmap");
		layerControl.addTo(map);
	}

	//add layers to overlays - wait for map to be created/data processing then create overlays
	function addOverlays() {
		if (heat!==undefined && acc!==undefined && accByType!==undefined) {
			overlays["Accidents"] = acc;
			overlays["Accidents by Travel Mode"] = accByType;
			overlays["CAIC Zones"] = zones;
			overlays["Heatmap"] = heat;
			addControlLayersToMap(baseLayers, overlays, map);
			updateLegend();
		}
		else {
			setTimeout(addOverlays, 50);
		}
	}

	addOverlays();
	
	// once the dates are selected, format and display the range in the date selection box.
	function updateDisplayedDateRange (start, end) {
			$('#reportrange span').html(start.format('MMM D, YYYY') + ' - ' + end.format('MMM D, YYYY'));
		}
	
	//Sets the dropdowns and ranges for the date range picker
	$('#reportrange').daterangepicker({
		"showDropdowns": false,
		"startDate": moment('2018-10-01'),
		"endDate": moment('2023-09-30'),
		ranges: {
				'Current Avalanche Year': [moment('2022-10-01'), moment('2023-09-30')],
				'Last Avalanche Year': [moment('2021-10-01'), moment('2022-09-30')],
				'Last 5 Avalanche Years': [moment('2018-10-01'), moment('2023-09-30')],
				'Last 10 Avalanche Years': [moment('2013-10-01'), moment('2023-09-30')],
				'All': [moment('2008-01-01'), moment()],
				},
				//maxDate: moment()
		}, updateDisplayedDateRange,
	);
	
	//Sets the initial dates in the date range picker - 5 avalanche years
	updateDisplayedDateRange(moment('2018-10-01'), moment('2023-09-30'));
	
	
	//Upon changes to the date ranges, checks if each accident is after the start date
	//Removes the accident layer and re-adds it with the date filter settings
	$('#reportrange').on('apply.daterangepicker', function (ev, picker) {			
			activity = 0;
			month = 0;
			mode = 0;
			firstSelect=0;
			secondSelect=0;
			thirdSelect=0;
			fourthSelect=0;
			barLabels.length=0;
			barChartDates.length=0;
			barChartModeArr.length=0;
			roseData.length=0;
			rosePieChart.filterAll();
			roseFilters = rosePieChart.filters();
			lassoIDs.length=0;
			mapChange();
			actSelected = 0;
			monthSelected = 0;
			modeSelected = 0;
			roseSelected =0;
			updateActivityChart();
			processBarChartDates();			
			processBarChartMode();
			processRose();			

	});
	
		
	updateActivityChart();
	processBarChartDates();
	processBarChartMode();
	processRose();
		
	//Setting empty arrays to hold graph data
	let barLabels=[];
	let barChartDates=[];
	let barChartModeArr =[];
	let roseData = [];

		
		
	function updateActivityChart() {
		//await delay (450);
		//console.log(barLabels);
		if (acc != undefined){
			if (barLabels.length > 0 || Object.keys(acc._layers).length==0){
				
				//Reduce the array of all activity types to an object with counts of unique activities
				const accCount = barLabels.reduce((allNames, name) => {
					const currCount = allNames[name] ?? 0;
					return {
					...allNames,
					[name]: currCount + 1,
					};
					}, {});
			
				//Grab the keys and values from the accCount
				barLabels2=Object.keys(accCount);
				barValues=Object.values(accCount);
				
				//Update the bar chart with the labels and values
				barChartCanvas.data.labels = barLabels2;
				barChartCanvas.data.datasets[0].data=barValues;
				
				//Reset the outline of any previously selected activity
				const dataset = barChartCanvas.data.datasets[0];
				dataset.borderWidth = [];
				dataset.borderColor = [];
				for (let i = 0; i < dataset.data.length; i++) {
					dataset.borderWidth[i] = 1;
					dataset.borderColor[i] = "rgba(0, 0, 0, 0.1)";
					}
				barChartCanvas.options.plugins.title.text = "Accidents by Activity Type";
				barChartCanvas.update();	
			}
			else{
				setTimeout(updateActivityChart, 50);
			}
		}
	  else{
		setTimeout(updateActivityChart, 50);
		}
	  }

	
	//default fonts for charts
	Chart.defaults.font.family = 'Nanum Gothic';
	Chart.defaults.font.color = '#333';

	//Stores whether selections have been made in charts
	var actSelected = 0, monthSelected = 0, modeSelected = 0, roseSelected = 0, firstSelect =0,
	secondSelect=0, thirdSelect=0, fourthSelect=0;
	
	//Properties for activity bar graph
	const canvas = document.getElementById("barChartCanvas");
	const ctx = canvas.getContext('2d');
	const barChartCanvas = new Chart(ctx, {
			type: 'bar',
			data: {
				labels: barLabels,
				datasets: [{
					data: [],
					borderColor: 'rgba(0, 0, 0, 0.1)',
					borderWidth: 1,
					backgroundColor:'#cdced6'
					
				}]
			},
			options: {
				plugins:{
				legend: false,
				title: {
					display: true,
					text: 'Accidents by Activity Type',
					position: 'top'
					}
				},
				maintainAspectRatio: false,
				onClick : evt=> {
					const points = barChartCanvas.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
					if (points.length) {
						actSelected = 1;
						const clickedPoint = points[0];
						activity = barChartCanvas.data.labels[clickedPoint.index];
						const value = barChartCanvas.data.datasets[clickedPoint.datasetIndex].data[clickedPoint.index];
						const actLabels = barChartCanvas.options.scales.x.ticks;
						const dataset = barChartCanvas.data.datasets[0];
						dataset.borderWidth = [];
						dataset.borderColor = [];
						for (let i = 0; i < dataset.data.length; i++) {
							if (clickedPoint.index == i) {
								dataset.borderWidth[i] = 4;
								dataset.borderColor[i] = "black";
							} else {
								dataset.borderWidth[i] = 1;
								dataset.borderColor[i] = "rgba(0, 0, 0, 0.1)";
							}
						}
						if (monthSelected ==0 && modeSelected==0 && firstSelect==0 && roseSelected==0) {
							firstSelect= "activity";
							titleText="1st Filter";
							barChartDates.length=0;
							processBarChartDates();
							barChartModeArr.length=0;
							processBarChartMode();
							roseData.length=0;
							processRose();
							}
						else if (firstSelect == "activity") {
							titleText="1st Filter";
							monthSelected,month,modeSelected,mode,roseSelected=0;
							secondSelect,thirdSelect,fourthSelect=0;
							barChartDates.length=0;
							processBarChartDates();
							barChartModeArr.length=0;
							processBarChartMode();
							roseData.length=0;
							processRose();
							}
						else if ((secondSelect==0 && firstSelect=="mode") || (secondSelect=="activity" && firstSelect=="mode"))  {
							secondSelect="activity";
							titleText="2nd Filter";
							thirdSelect,fourthSelect=0;
							monthSelected,month = 0;
							roseSelected=0;
							barChartDates.length=0;
							processBarChartDates();
							roseData.length=0;
							processRose();
							}
						else if ((secondSelect==0 && firstSelect=="month") || (secondSelect=="activity" && firstSelect=="month"))  {
							secondSelect="activity";
							titleText="2nd Filter";
							thirdSelect,fourthSelect=0;
							modeSelected,mode = 0;
							roseSelected=0;
							barChartModeArr.length=0;
							processBarChartMode();
							roseData.length=0;
							processRose();
							}
						else if ((secondSelect==0 && firstSelect=="rose") || (secondSelect=="activity" && firstSelect=="rose"))  {
							secondSelect="activity";
							titleText="2nd Filter";
							thirdSelect,fourthSelect=0;
							modeSelected,mode = 0;
							monthSelected,month = 0;
							barChartModeArr.length=0;
							processBarChartMode();
							barChartDates.length=0;
							processBarChartDates();
							}
						else if ((thirdSelect==0 && secondSelect=="rose" && firstSelect=="month") || (thirdSelect==0 && secondSelect=="month" && firstSelect=="rose") || (thirdSelect=="activity" && secondSelect=="rose" && firstSelect=="month") || (thirdSelect=="activity" && secondSelect=="month" && firstSelect=="rose")){
							thirdSelect="activity";
							titleText="3rd Filter";
							fourthSelect=0;
							modeSelected,mode = 0;
							barChartModeArr.length=0;
							processBarChartMode();
							}
						else if (thirdSelect==0 && secondSelect=="rose" && firstSelect=="mode" || thirdSelect==0 && secondSelect=="mode" && firstSelect=="rose" || thirdSelect=="activity" && secondSelect=="rose" && firstSelect=="mode" || thirdSelect=="activity" && secondSelect=="mode" && firstSelect=="rose"){
							thirdSelect="activity";
							titleText="3rd Filter";
							fourthSelect=0;
							monthSelected,month = 0;
							barChartDates.length=0;
							processBarChartDates();
							}
						else if (thirdSelect==0 && secondSelect=="month" && firstSelect=="mode" || thirdSelect==0 && secondSelect=="mode" && firstSelect=="month" || thirdSelect=="activity" && secondSelect=="month" && firstSelect=="mode" || thirdSelect=="activity" && secondSelect=="mode" && firstSelect=="month"){
							thirdSelect="activity";
							titleText="3rd Filter";
							fourthSelect=0;
							roseSelected=0;
							roseData.length=0;
							processRose();
							}
						else  {
							fourthSelect="activity";
							titleText="4th Filter";
							}
						//console.log(activity, month, mode, firstSelect, secondSelect, thirdSelect,actSelected, monthSelected, modeSelected);
						barChartCanvas.options.plugins.title.text = "Accidents by Activity Type | "+titleText+": "+value;
						barChartCanvas.update();
						mapChange();
				  }},

				scales: {
				x: {
					title:{
						text: 'Activity Type',
						display: false
					}

					},
					
				y:{
					title:{
						text: 'Accidents',
						display: true
					},
					ticks: {
						callback: function(value) {if (value % 1 === 0) {return value;}}
					}
				}
			}
		}});
	
	let barChart = new Chart('bar-chart', {
		type: 'bar',
		options: {
			plugins: {
				title: {
					display: true,
					text: 'Accidents by Month',
					padding: {
						top: 10,
						bottom: 10
                	}
				},
				legend: false
			},
			maintainAspectRatio: false,
			onClick : evt=> {
					const points = barChart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
					if (points.length) {
						monthSelected = 1;
						const clickedPoint = points[0];
						month = barChart.data.labels[clickedPoint.index];
						const value = barChart.data.datasets[clickedPoint.datasetIndex].data[clickedPoint.index];
						const monthLabels = barChart.options.scales.x.ticks;
						const dataset = barChart.data.datasets[0];
						dataset.borderWidth = [];
						dataset.borderColor = [];
						for (let i = 0; i < dataset.data.length; i++) {
							if (clickedPoint.index == i) {
								dataset.borderWidth[i] = 4;
								dataset.borderColor[i] = "black";
							} else {
								dataset.borderWidth[i] = 1;
								dataset.borderColor[i] = "rgba(0, 0, 0, 0.1)";
							}
						}
						if (actSelected==0 && modeSelected==0 && firstSelect==0 && roseSelected==0) {
							firstSelect= "month";
							titleText="1st Filter";
							barLabels.length=0;
							updateActivityChart();
							barChartModeArr.length=0;
							processBarChartMode();
							roseData.length=0;
							processRose();
							}
						else if (firstSelect == "month") {
							titleText="1st Filter";
							actSelected,activity,modeSelected,mode,roseSelected=0;
							secondSelect,thirdSelect,fourthSelect=0;
							barLabels.length=0;
							updateActivityChart();
							barChartModeArr.length=0;
							processBarChartMode();
							roseData.length=0;
							processRose();
							}
						else if ((secondSelect==0 && firstSelect=="activity") || (secondSelect=="month" && firstSelect=="activity"))  {
							secondSelect="month";
							titleText="2nd Filter";
							thirdSelect, fourthSelect=0;
							mode, modeSelected, roseSelected =0;
							barChartModeArr.length=0;
							processBarChartMode();
							roseData.length=0;
							processRose();
							}
						else if ((secondSelect==0 && firstSelect=="mode") || (secondSelect=="month" && firstSelect=="mode")) {
							secondSelect="month";
							titleText="2nd Filter";
							thirdSelect, fourthSelect=0;
							activity, actSelected, roseSelected =0;
							barLabels.length=0;
							updateActivityChart();
							roseData.length=0;
							processRose();
							}
						else if ((secondSelect==0 && firstSelect=="rose") || (secondSelect=="month" && firstSelect=="rose")) {
							secondSelect="month";
							titleText="2nd Filter";
							thirdSelect, fourthSelect=0;
							activity, actSelected, mode, modeSelected =0;
							barLabels.length=0;
							updateActivityChart();
							barChartModeArr.length=0;
							processBarChartMode();
							}
						else if ((thirdSelect==0 && secondSelect=="rose" && firstSelect=="activity") || (thirdSelect==0 && secondSelect=="activity" && firstSelect=="rose") || (thirdSelect=="month" && secondSelect=="rose" && firstSelect=="activity") || (thirdSelect=="month" && secondSelect=="activity" && firstSelect=="rose")){
							thirdSelect="month";
							titleText="3rd Filter";
							fourthSelect=0;
							modeSelected,mode = 0;
							barChartModeArr.length=0;
							processBarChartMode();
							}
						else if (thirdSelect==0 && secondSelect=="rose" && firstSelect=="mode" || thirdSelect==0 && secondSelect=="mode" && firstSelect=="rose" || thirdSelect=="month" && secondSelect=="rose" && firstSelect=="mode" || thirdSelect=="month" && secondSelect=="mode" && firstSelect=="rose"){
							thirdSelect="month";
							titleText="3rd Filter";
							fourthSelect=0;
							actSelected,activity = 0;
							barLabels.length=0;
							updateActivityChart();
							}
						else if (thirdSelect==0 && secondSelect=="activity" && firstSelect=="mode" || thirdSelect==0 && secondSelect=="mode" && firstSelect=="activity" || thirdSelect=="month" && secondSelect=="activity" && firstSelect=="mode" || thirdSelect=="month" && secondSelect=="mode" && firstSelect=="activity"){
							thirdSelect="month";
							titleText="3rd Filter";
							fourthSelect=0;
							roseSelected=0;
							roseData.length=0;
							processRose();
							}		
						else {
							fourthSelect="month";
							titleText="4th Filter";
							}
						//console.log(activity, month, mode, firstSelect, secondSelect, thirdSelect,actSelected, monthSelected, modeSelected);
						barChart.options.plugins.title.text = "Accidents by Month | "+titleText+": "+value;
						barChart.update();
						mapChange();
				  }},
			scales: {
				x: {
					title:{
						text: 'Month',
						display: false
						}
				},
						
				y: {
					title:{
						text: 'Accidents',
						display: true
						},
					ticks: {callback: function(value) {if (value % 1 === 0) {return value;}}}
				}				
					
			}
		},
		data: {
			datasets: [
				{
				backgroundColor:'#cdced6'
        }
			]
		}
		
	});

	function processBarChartDates() {
		//await delay (450);
		if (acc != undefined){
			if (barChartDates.length > 0 || Object.keys(acc._layers).length==0){
				/* console.log("barChartDates: ", barChartDates); */
				/* Reduce the array of all accident dates  to an object with counts of unique months */
				let dateData = barChartDates.reduce((allDates, month) => {
						const currentCount = allDates[month] ?? 0;
						return {
						...allDates,
						[month]: currentCount + 1,
						};
				}, {});

				/* Convert the dates and counts to array and sort by month */
				let dateDataArr=Object.entries(dateData);
				sortByMonth(dateDataArr);
				function sortByMonth(arr) {
					var months = ['Oct', 'Nov', 'Dec','Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep'];
					arr.sort(function(a, b){
					return months.indexOf(a[0]) - months.indexOf(b[0]);
				});
				}
				
				let barChartKeys = Object.keys(Object.fromEntries(dateDataArr));
				barChartValues=Object.values(Object.fromEntries(dateDataArr));
				
				/* // Update the bar chart with the labels and values */
				barChart.data.labels = barChartKeys;
				barChart.data.datasets[0].data=barChartValues;
				
				// Reset highlighting of previously selected month
				const dataset = barChart.data.datasets[0];
					dataset.borderWidth = [];
					dataset.borderColor = [];
					for (let i = 0; i < dataset.data.length; i++) {
						dataset.borderWidth[i] = 1;
						dataset.borderColor[i] = "rgba(0, 0, 0, 0.1)";
						}
				barChart.options.plugins.title.text = "Accidents by Month";
				barChart.update();
			}
			else{
				setTimeout(processBarChartDates, 50);
			}
		}
		else{
		  setTimeout(processBarChartDates, 50);
		}
	}

	let barChartMode = new Chart('bar-chart-mode', {
		type: 'bar',
		options: {
			plugins: {
				title: {
					display: true,
					text: 'Accidents by Mode of Travel',
					padding: {
						top: 10,
						bottom: 10
                	}
				},
				legend: false
			},
				onClick : evt=> {
					const points = barChartMode.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
					if (points.length) {
						modeSelected = 1;
						const clickedPoint = points[0];
						mode = barChartMode.data.labels[clickedPoint.index];
						const value = barChartMode.data.datasets[clickedPoint.datasetIndex].data[clickedPoint.index];
						const actLabels = barChartMode.options.scales.x.ticks;
						const dataset = barChartMode.data.datasets[0];
						dataset.borderWidth = [];
						dataset.borderColor = [];
						for (let i = 0; i < dataset.data.length; i++) {
							if (clickedPoint.index == i) {
								dataset.borderWidth[i] = 4;
								dataset.borderColor[i] = "black";
							} else {
								dataset.borderWidth[i] = 1;
								dataset.borderColor[i] = "rgba(0, 0, 0, 0.1)";
							}
						}
						if (monthSelected ==0 && actSelected==0 && firstSelect==0 && roseSelected ==0) {
							firstSelect= "mode";
							titleText="1st Filter";
							barLabels.length=0;
							updateActivityChart();
							barChartDates.length=0;
							processBarChartDates();
							roseData.length=0;
							processRose();
							}
						else if (firstSelect == "mode") {
							titleText="1st Filter";
							monthSelected, month, actSelected, activity, roseSelected =0;
							secondSelect, thirdSelect, fourthSelect=0;
							barLabels.length=0;
							updateActivityChart();
							barChartDates.length=0;
							processBarChartDates();
							roseData.length=0;
							processRose();
							}
						else if ((secondSelect==0 && firstSelect=="activity") || (secondSelect=="mode" && firstSelect=="activity"))  {
							secondSelect="mode";
							titleText="2nd Filter";
							thirdSelect,fourthSelect=0;
							month, monthSelected, roseSelected=0;
							barChartDates.length=0;
							processBarChartDates();
							roseData.length=0;
							processRose();
							}
						else if ((secondSelect==0 && firstSelect=="month") ||(secondSelect=="mode" && firstSelect=="month"))  {
							secondSelect="mode";
							titleText="2nd Filter";
							thirdSelect,fourthSelect=0;
							activity, actSelected, roseSelected =0;
							barLabels.length=0;
							updateActivityChart();
							roseData.length=0;
							processRose();
							}
						else if ((secondSelect==0 && firstSelect=="rose") ||(secondSelect=="mode" && firstSelect=="rose"))  {
							secondSelect="mode";
							titleText="2nd Filter";
							thirdSelect,fourthSelect=0;
							activity, actSelected, month, monthSelected =0;
							barLabels.length=0;
							updateActivityChart();
							barChartDates.length=0;
							processBarChartDates();
							}
						else if ((thirdSelect==0 && secondSelect=="rose" && firstSelect=="activity") || (thirdSelect==0 && secondSelect=="activity" && firstSelect=="rose") || (thirdSelect=="mode" && secondSelect=="rose" && firstSelect=="activity") || (thirdSelect=="mode" && secondSelect=="activity" && firstSelect=="rose")){
							thirdSelect="mode";
							titleText="3rd Filter";
							fourthSelect=0;
							monthSelected,month = 0;
							barChartDates.length=0;
							processBarChartDates();
							}
						else if (thirdSelect==0 && secondSelect=="rose" && firstSelect=="month" || thirdSelect==0 && secondSelect=="month" && firstSelect=="rose" || thirdSelect=="mode" && secondSelect=="rose" && firstSelect=="month" || thirdSelect=="mode" && secondSelect=="month" && firstSelect=="rose"){
							thirdSelect="mode";
							titleText="3rd Filter";
							fourthSelect=0;
							actSelected,activity = 0;
							barLabels.length=0;
							updateActivityChart();
							}
						else if (thirdSelect==0 && secondSelect=="activity" && firstSelect=="month" || thirdSelect==0 && secondSelect=="month" && firstSelect=="activity" || thirdSelect=="mode" && secondSelect=="activity" && firstSelect=="month" || thirdSelect=="mode" && secondSelect=="month" && firstSelect=="activity"){
							thirdSelect="mode";
							titleText="3rd Filter";
							fourthSelect=0;
							roseSelected=0;
							roseData.length=0;
							processRose();
							}	
						else {
							fourthSelect="mode";
							titleText="4th Filter";
							}
						//console.log(activity, month, mode, firstSelect, secondSelect, thirdSelect, actSelected, monthSelected, modeSelected);
						barChartMode.options.plugins.title.text = "Accidents by Travel Mode | "+titleText+": "+value;
						barChartMode.update();
						mapChange();
				  }},
			// on click here 
			maintainAspectRatio: false,
			scales: {
				x: {
					title:{
						text: 'Month',
						display: false
						}
				},
						
				y: {
					title:{
						text: 'Accidents',
						display: true
						},
					ticks: {callback: function(value) {if (value % 1 === 0) {return value;}}}
				}				
					
			}
		},
		data: {
			datasets: [
				{
				backgroundColor:'#cdced6'
        }
			]
		}
		
	});

	function processBarChartMode() {
		//await delay (450);
		if (acc != undefined){
			if (barChartModeArr.length > 0 || Object.keys(acc._layers).length==0){
				let dateDataMode = barChartModeArr.reduce((allDates, month) => {
						const currentCountMode = allDates[month] ?? 0;
						return {
						...allDates,
						[month]: currentCountMode + 1,
						};
				}, {});

				let dateDataArrMode=Object.entries(dateDataMode);
				
				let barChartKeysMode = Object.keys(Object.fromEntries(dateDataArrMode));
				barChartValuesMode=Object.values(Object.fromEntries(dateDataArrMode));
				
				/* // Update the bar chart with the labels and values */
				barChartMode.data.labels = barChartKeysMode;
				barChartMode.data.datasets[0].data=barChartValuesMode;
				
				// Reset highlighting of previously selected mode
				const dataset = barChartMode.data.datasets[0];
					dataset.borderWidth = [];
					dataset.borderColor = [];
					for (let i = 0; i < dataset.data.length; i++) {
						dataset.borderWidth[i] = 1;
						dataset.borderColor[i] = "rgba(0, 0, 0, 0.1)";
						}
				barChartMode.options.plugins.title.text = "Accidents by Travel Mode";
				barChartMode.update();
			}
			else{
				setTimeout(processBarChartMode, 50);
			}
		}
		else{
		  setTimeout(processBarChartMode, 50);
		}
	}



	function processRose() {
		if (acc != undefined) {
			//if the length of the roseData array >0 or there is nothing in the acc layer
			if (roseData.length > 0 || Object.keys(acc._layers).length == 0) {
				var ndx = crossfilter(roseData),
					roseDimension = ndx.dimension(function (d) {
						return d.roseField;
					});

				var rosePieVals = roseDimension.group().top(Infinity);
				//console.log(rosePieVals);
				var pieSum = 0;

				ROSE_KEYS.forEach(key => {
					var pieVal = rosePieVals.find(groupedVal => groupedVal.key === key) || { value: 0 };
					$(`[filter='${key}']`).find('text').text(pieVal.value || '');
				});
				
				//console.log(pieSum);
				// if there are no filters, shows everything as selected by removing not-selected class
				if (roseFilters.length === 0) {
					$('.avy-rose-part').removeClass('not-selected');
					$('.chart-title').html('Avalanche Rose');
				}
				// if there are filters, add up the sums for the rosePieVals
				else {
					//console.log(roseFilters);
					// De-select all the avy-rose-parts
					$('.avy-rose-part').addClass('not-selected');
					// and then remove this deselected class from the ones that are indeed selected.
					roseFilters.forEach(filter => {
						var pieValFilt = rosePieVals.find(groupedVal => groupedVal.key === filter) || { value: 0 };
						$(`[filter='${filter}']`).removeClass('not-selected');
						pieSum += parseInt(pieValFilt.value);
					});

						$('.chart-title').html('Avalanche Rose | '+titleText+': '+pieSum);
					}
				}
		
			else {
				setTimeout(processRose, 50);
			}
		}
		else {
			setTimeout(processRose, 50);
		}
	}

	d3.selectAll(".avy-rose-part")
		.on("mouseover", function () {
			d3.select(this).classed('hovered', true);
		})
		.on("mouseout", function () {
			d3.select(this).classed('hovered', false);
		})
		.on('click', function () {
			// toggle the filter on the chart
			//console.log($(this).attr('filter'));
			rosePieChart.filter($(this).attr('filter'));
			roseSelected = 1;
			roseData.length=0;
			if (monthSelected ==0 && actSelected==0 && firstSelect==0 && modeSelected ==0) {
				firstSelect= "rose";
				titleText="1st Filter";
				barLabels.length=0;
				updateActivityChart();
				barChartDates.length=0;
				processBarChartDates();
				barChartModeArr.length=0;
				processBarChartMode();
				}
			else if (firstSelect == "rose") {
				titleText="1st Filter";
				monthSelected, month, actSelected, activity, modeSelected, mode =0;
				secondSelect, thirdSelect, fourthSelect=0;
				barLabels.length=0;
				updateActivityChart();
				barChartDates.length=0;
				processBarChartDates();
				barChartModeArr.length=0;
				processBarChartMode();
				//roseData.length=0;
				//processRose();
				}
			else if ((secondSelect==0 && firstSelect=="activity") || (secondSelect=="rose" && firstSelect=="activity"))  {
				secondSelect="rose";
				titleText="2nd Filter";
				thirdSelect,fourthSelect=0;
				month, monthSelected, mode, modeSelected=0;
				barChartDates.length=0;
				processBarChartDates();
				barChartModeArr.length=0;
				processBarChartMode();
				}
			else if ((secondSelect==0 && firstSelect=="month") ||(secondSelect=="rose" && firstSelect=="month"))  {
				secondSelect="rose";
				titleText="2nd Filter";
				thirdSelect,fourthSelect=0;
				activity, actSelected, mode, modeSelected=0;
				barLabels.length=0;
				updateActivityChart();
				barChartModeArr.length=0;
				processBarChartMode();
				}
			else if ((secondSelect==0 && firstSelect=="mode") ||(secondSelect=="rose" && firstSelect=="mode"))  {
				secondSelect="rose";
				titleText="2nd Filter";
				thirdSelect,fourthSelect=0;
				activity, actSelected, month, monthSelected =0;
				barLabels.length=0;
				updateActivityChart();
				barChartDates.length=0;
				processBarChartDates();
				}
			else if ((thirdSelect==0 && secondSelect=="mode" && firstSelect=="activity") || (thirdSelect==0 && secondSelect=="activity" && firstSelect=="mode") || (thirdSelect=="rose" && secondSelect=="mode" && firstSelect=="activity") || (thirdSelect=="rose" && secondSelect=="activity" && firstSelect=="mode")){
				thirdSelect="rose";
				titleText="3rd Filter";
				fourthSelect=0;
				monthSelected,month = 0;
				barChartDates.length=0;
				processBarChartDates();
				}
			else if (thirdSelect==0 && secondSelect=="mode" && firstSelect=="month" || thirdSelect==0 && secondSelect=="month" && firstSelect=="mode" || thirdSelect=="rose" && secondSelect=="mode" && firstSelect=="month" || thirdSelect=="rose" && secondSelect=="month" && firstSelect=="mode"){
				thirdSelect="rose";
				titleText="3rd Filter";
				fourthSelect=0;
				actSelected,activity = 0;
				barLabels.length=0;
				updateActivityChart();
				}
			else if (thirdSelect==0 && secondSelect=="activity" && firstSelect=="month" || thirdSelect==0 && secondSelect=="month" && firstSelect=="activity" || thirdSelect=="rose" && secondSelect=="activity" && firstSelect=="month" || thirdSelect=="rose" && secondSelect=="month" && firstSelect=="activity"){
				thirdSelect="mode";
				titleText="3rd Filter";
				fourthSelect=0;
				modeSelected, mode=0;
				barChartModeArr.length=0;
				processBarChartMode();
				}	
			else {
				fourthSelect="mode";
				titleText="4th Filter";
				}
			mapChange();
			var ndx = crossfilter(roseData),
					roseDimension = ndx.dimension(function (d) {
						return d.roseField;
					});

			var rosePieVals = roseDimension.group().top(Infinity);
			var pieSum = 0;
			$('.avy-rose-part').addClass('not-selected');
					// and then remove this deselected class from the ones that are indeed selected.
			roseFilters.forEach(filter => {
				var pieValFilt = rosePieVals.find(groupedVal => groupedVal.key === filter) || { value: 0 };
				$(`[filter='${filter}']`).removeClass('not-selected');
				pieSum += parseInt(pieValFilt.value);
			});
			$('.chart-title').html('Avalanche Rose | '+titleText+': '+pieSum);	
		});
	
	$('.rose-multiselector').click(el => {
		// remove all the existing filters on the rose
		rosePieChart.filterAll();

		// get the filters to be applied from the element's filter attr
		let filter = JSON.parse($(el.target).attr('filter') || '[]');

		// apply and redraw
		rosePieChart.filter([filter]);
		roseFilters = rosePieChart.filters();
		roseSelected = 1;
		roseData.length=0;
		if (monthSelected ==0 && actSelected==0 && firstSelect==0 && modeSelected ==0) {
			firstSelect= "rose";
			titleText="1st Filter";
			barLabels.length=0;
			updateActivityChart();
			barChartDates.length=0;
			processBarChartDates();
			barChartModeArr.length=0;
			processBarChartMode();
			}
		else if (firstSelect == "rose") {
			titleText="1st Filter";
			monthSelected, month, actSelected, activity, modeSelected, mode =0;
			secondSelect, thirdSelect, fourthSelect=0;
			barLabels.length=0;
			updateActivityChart();
			barChartDates.length=0;
			processBarChartDates();
			barChartModeArr.length=0;
			processBarChartMode();
			//roseData.length=0;
			//processRose();
			}
		else if ((secondSelect==0 && firstSelect=="activity") || (secondSelect=="rose" && firstSelect=="activity"))  {
			secondSelect="rose";
			titleText="2nd Filter";
			thirdSelect,fourthSelect=0;
			month, monthSelected, mode, modeSelected=0;
			barChartDates.length=0;
			processBarChartDates();
			barChartModeArr.length=0;
			processBarChartMode();
			}
		else if ((secondSelect==0 && firstSelect=="month") ||(secondSelect=="rose" && firstSelect=="month"))  {
			secondSelect="rose";
			titleText="2nd Filter";
			thirdSelect,fourthSelect=0;
			activity, actSelected, mode, modeSelected=0;
			barLabels.length=0;
			updateActivityChart();
			barChartModeArr.length=0;
			processBarChartMode();
			}
		else if ((secondSelect==0 && firstSelect=="mode") ||(secondSelect=="rose" && firstSelect=="mode"))  {
			secondSelect="rose";
			titleText="2nd Filter";
			thirdSelect,fourthSelect=0;
			activity, actSelected, month, monthSelected =0;
			barLabels.length=0;
			updateActivityChart();
			barChartDates.length=0;
			processBarChartDates();
			}
		else if ((thirdSelect==0 && secondSelect=="mode" && firstSelect=="activity") || (thirdSelect==0 && secondSelect=="activity" && firstSelect=="mode") || (thirdSelect=="rose" && secondSelect=="mode" && firstSelect=="activity") || (thirdSelect=="rose" && secondSelect=="activity" && firstSelect=="mode")){
			thirdSelect="rose";
			titleText="3rd Filter";
			fourthSelect=0;
			monthSelected,month = 0;
			barChartDates.length=0;
			processBarChartDates();
			}
		else if (thirdSelect==0 && secondSelect=="mode" && firstSelect=="month" || thirdSelect==0 && secondSelect=="month" && firstSelect=="mode" || thirdSelect=="rose" && secondSelect=="mode" && firstSelect=="month" || thirdSelect=="rose" && secondSelect=="month" && firstSelect=="mode"){
			thirdSelect="rose";
			titleText="3rd Filter";
			fourthSelect=0;
			actSelected,activity = 0;
			barLabels.length=0;
			updateActivityChart();
			}
		else if (thirdSelect==0 && secondSelect=="activity" && firstSelect=="month" || thirdSelect==0 && secondSelect=="month" && firstSelect=="activity" || thirdSelect=="rose" && secondSelect=="activity" && firstSelect=="month" || thirdSelect=="rose" && secondSelect=="month" && firstSelect=="activity"){
			thirdSelect="mode";
			titleText="3rd Filter";
			fourthSelect=0;
			modeSelected, mode=0;
			barChartModeArr.length=0;
			processBarChartMode();
			}	
		else {
			fourthSelect="mode";
			titleText="4th Filter";
			}
		mapChange();
		var ndx = crossfilter(roseData),
				roseDimension = ndx.dimension(function (d) {
					return d.roseField;
				});
		var rosePieVals = roseDimension.group().top(Infinity);
		var pieSum = 0;
		$('.avy-rose-part').addClass('not-selected');
				// and then remove this deselected class from the ones that are indeed selected.
		roseFilters.forEach(filter => {
			var pieValFilt = rosePieVals.find(groupedVal => groupedVal.key === filter) || { value: 0 };
			$(`[filter='${filter}']`).removeClass('not-selected');
			pieSum += parseInt(pieValFilt.value);
		});
		
		$('.chart-title').html('Avalanche Rose | '+titleText+': '+pieSum);
	});

	L.control.scale().addTo(map);

</script>

</body>
</html>
