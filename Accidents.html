<!DOCTYPE html>
<html>
<head>
	
	<title>CAIC Accidents Map</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="shortcut icon" type="image/x-icon" href="images/blue_snow_icon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
	
		<!-- Loading Leaflet Omnivore to read CSV file -->
	<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>
  <!-- Loading Leaflet heatmap plugin -->
	<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-heat/v0.1.3/leaflet-heat.js'></script>
	
		<!-- Loading fontawesome -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"/>
	
	<!-- Loading Leaflet EasyButton -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
	<script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>

	<style>
		@import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&family=Raleway&display=swap');
		html, body {
			height: 100%;
			margin: 0;
		}
		#map { width: 100%; height: 100%; font-family: 'Nanum Gothic', sans-serif;}

		.info { padding: 6px 8px; font: 14px/16px, 'Nanum Gothic', Arial, Helvetica, sans-serif; background: white; 
			background: rgba(255,255,255,0.8); box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 5px; } 
		.info h4 { margin: 0 0 5px; color: #777; }
		.legend { text-align: left; line-height: 18px; color: rgb(147, 139, 139); } 
		.legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.7; }
		.leaflet-popup-content-wrapper, .leaflet-popup.tip {
			background-color: #e3e4ee9a;
			padding: 4px;
		}
	</style>
	
</head>
<body>

<div id='map'></div>
	<script type="text/javascript">
	
	var map = L.map('map').setView([39.118413163683854, -106.44565988833477], 7.5);
	
	var Esri_WorldTerrain = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}', {
		attribution: 'Tiles &copy; Esri &mdash; Source: Esri',
		maxZoom: 13
	}).addTo(map);
	
	var Stamen_Terrain = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}{r}.{ext}', {
		attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
		subdomains: 'abcd',
		minZoom: 0,
		maxZoom: 15,
		ext: 'png'
	})
	
	var imagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
		attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
	});
		
	var lGrey = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}{r}.{ext}', {
		attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
		subdomains: 'abcd',
		minZoom: 0,
		maxZoom: 20,
		ext: 'png'
	});
	
	var osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });
	
	
	//Zoom settings for home button
	var home = {
		lat: 39.118413163683854,
		lng: -106.44565988833477,
		zoom: 7.5
		}; 
				
	//Adds home button to map
	L.easyButton('fa fa-home',function(btn,map){
		map.setView([home.lat, home.lng], home.zoom);
		},'Zoom To Home').addTo(map);
	
	//Get style color by Dscale
	function getColor(d) {
		return d < 1.5 ?  '#ffff00' :
				d < 2  ? '#ffe800' :
				d < 2.5  ? '#ffd000' :
				d < 3  ? '#ffb800':
				d < 3.5 ? '#ff9f00':
				d < 4 ? '#ff8400':
				d < 4.5 ? '#ff6700':
				d < 5 ? '#ff4500':
				d < 999 ? '#ff0000':
						 '#ffffff';
	};

	//Get radius by Rscale
	function getSize(d) {
		return d < 1.5 ?  6 :
				d < 2  ? 6 :
				d < 2.5  ? 7 :
				d < 3  ? 7:
				d < 3.5 ? 8:
				d < 4 ? 8:
				d < 4.5 ? 9:
				d < 5 ? 9:
				d < 999 ? 10:
						 6;
	};
	
	
	//Basic style for accident points
	function style(feature) {
		return {
			//radius: 7,
			radius: getSize(feature.properties.Rscale),
			weight: 1.5,
			opacity: 1,
			color: 'white',
			dashArray: '',
			fillOpacity: 0.8,
			//fillColor: 'blue',
			//Below is to set the color by a variable, in this case by Dscale)
			fillColor: getColor(feature.properties.Dscale)
		};
	}

	//Style of accident points upon cursor hover
	function highlightFeature(e) {
		var layer = e.target;

		layer.setStyle({
			weight: 3,
			color: '#666',
			dashArray: '',
			fillOpacity: 0.7
		});

		if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
			layer.bringToFront();
		}

	}

	function resetHighlight(e) {
		acc.resetStyle(e.target);
	}


	//from csv we get 11-Feb-10 change to 02/11/2010
	function formatDate(inputDate) {
		var date = new Date(inputDate);
		if (!isNaN(date.getTime())) {
		// Months use 0 index.
		return date.getMonth() + 1 + '/' + date.getDate() + '/' + date.getFullYear();
    }

	}
	//Actions for mouseover, mouseout
	function onEachFeature(feature, layer) {
		layer.on({
			mouseover: highlightFeature,
			mouseout: resetHighlight
		});
		
		//content of the popup
		layer.bindPopup("<strong>" + feature.properties.acc_location +"</strong><br>" + formatDate(feature.properties.acc_date) +
		"<br>" + feature.properties.acc_activity 
		+ "<br>R" + feature.properties.Rscale + " D" + feature.properties.Dscale +
		"<br>Caught: " + feature.properties.acc_no_caught + 
		", Buried: " + feature.properties.acc_no_buried + ", Killed: " + feature.properties.acc_no_killed + 
		"<br><a href=" + feature.properties.report + " target=_blank>Link to Report</a>");
	}


	// Create blank style geoJSON holder for CSV data
	var styleLayer = L.geoJson(null, {
		pointToLayer: function(geoJsonPoint, latlng) {
                        return L.circleMarker(latlng);},
						onEachFeature: onEachFeature,
						style:style
	});
	
	// Adding CSV from github (made repository public). Cross-Origin Request error if loaded locally.
	var acc = omnivore.csv('https://raw.githubusercontent.com/dseidlCoMtn/caic_accident/main/CO_Accidents.csv', null, styleLayer).addTo(map);
	
	//define csv url
	const url = 'https://raw.githubusercontent.com/dseidlCoMtn/caic_accident/main/CO_Accidents.csv';

	var baseLayers = {
    "Esri Terrain": Esri_WorldTerrain,
	"Stamen Terrain": Stamen_Terrain,
	"Imagery": imagery,
	"Light Grey": lGrey,
	"Open Street Map": osm,
	};

	var overlays = {
		"Accidents": acc,
	};

	//set heat as a global var
	var heat;

	//Create heatmap layer -- need to wait for call to CSV online
	//Function to call L.heatLayer
	function createHeatmap(map, points) {
		return L.heatLayer(points, {
			radius: 25,
			minOpacity: 0.45,
			gradient: {.3: 'cyan', 0.7: 'blue', .98: 'purple'}
		});
	};

	//function to parse csv from url
	function parseCSV(url) {
		return fetch(url)
			.then(response => response.text())
			.then(csv => {
				const rows = csv.split("\n");
				const points = [];

				for (const row of rows) {
					const values = row.split(",");
					const lat = parseFloat(values[4]);
					const lon = parseFloat(values[5]);
					if (!isNaN(lat) && !isNaN(lon)) {
						points.push([lat, lon]);
					}
				}
				
				return points;
			})
	};

	//function to add control layers to map
	function addControlLayersToMap(baseLayers, overlays, map) {
		L.control.layers(baseLayers, overlays, {collapsed: false}).addTo(map);
	}

	//add heat to overlays - wait for map to be created/data processing then create overlays

	function addHeatToOverlays() {
		if (heat!==undefined) {
			overlays["Heat"] = heat;
			addControlLayersToMap(baseLayers, overlays, map);
		}
		else {
			setTimeout(addHeatToOverlays, 50);
		}
	}

	//call functions
	//parse csv, create heatmap, assign var
	parseCSV(url).then(function(points) {
		heat = createHeatmap(map, points);
	});

	addHeatToOverlays();
	//L.control.layers(baseLayers, overlays, {collapsed: false}).addTo(map);
	
	L.control.scale().addTo(map);

</script>

</body>
</html>
